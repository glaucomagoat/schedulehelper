<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title>Schedule Helper</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“…</text></svg>">
<style>*{margin:0;padding:0;box-sizing:border-box}body{background:#0a0a1a;color:#e8e8f0;font-family:'DM Sans',sans-serif}#root{min-height:100vh}@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}</style>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
</head><body><div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script>
window.storage=(function(){
  var API='/.netlify/functions/storage-proxy';
  async function call(body){
    var r=await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    var d=await r.json();
    if(!r.ok)throw new Error(d.error||'Storage error');
    return d;
  }
  var migrated=false;
  async function migrate(){
    if(migrated)return;migrated=true;
    try{
      // Check if cloud already has data (session key = good indicator)
      var test=await call({action:'list',prefix:'session'});
      if(test.keys&&test.keys.length>0)return; // cloud has data, skip migration
    }catch(e){return;}
    // Collect all localStorage sc: keys
    var entries=[];
    for(var i=0;i<localStorage.length;i++){
      var k=localStorage.key(i);
      if(k&&k.startsWith('sc:')){entries.push({key:k.substring(3),value:localStorage.getItem(k)});}
    }
    if(entries.length===0)return;
    try{
      await call({action:'set-batch',entries:entries});
      console.log('Migrated '+entries.length+' keys to cloud storage');
    }catch(e){console.warn('Migration failed:',e);}
  }
  // Trigger migration on first storage call
  var migP=null;
  function ensureMigrated(){if(!migP)migP=migrate();return migP;}
  return{
    async get(key){await ensureMigrated();var d=await call({action:'get',key:key});return{key:d.key,value:d.value,shared:false};},
    async set(key,value){await ensureMigrated();await call({action:'set',key:key,value:value});return{key:key,value:value,shared:false};},
    async delete(key){await ensureMigrated();await call({action:'delete',key:key});return{key:key,deleted:true,shared:false};},
    async list(prefix){await ensureMigrated();var d=await call({action:'list',prefix:prefix||''});return{keys:d.keys||[],prefix:prefix,shared:false};}
  };
})();
</script><script type="text/babel">
const { useState, useEffect, useCallback, useRef } = React;

const DAYS_OF_WEEK = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
const MONTHS = ["January","February","March","April","May","June","July","August","September","October","November","December"];
const WEEKDAYS_ONLY = ["Mon","Tue","Wed","Thu","Fri"];

const defaultColors = [
  "#3B82F6","#10B981","#F59E0B","#EF4444","#8B5CF6","#EC4899","#06B6D4","#84CC16","#F97316","#6366F1",
  "#14B8A6","#E11D48","#7C3AED","#0EA5E9","#D946EF","#F43F5E","#22D3EE","#A3E635","#FB923C","#818CF8"
];

const DEV_USERNAME = "mike";
const DEV_PASSWORD = "banchan";

const PRESET_STAFF = [
  { id: "s1", name: "Steve Kim MD", role: "Ophthalmologist", color: "#3B82F6" },
  { id: "s2", name: "Steve Lin MD", role: "Ophthalmologist", color: "#10B981" },
  { id: "s3", name: "Daniel Choi MD", role: "Ophthalmologist", color: "#F59E0B" },
  { id: "s4", name: "Mike Yang MD", role: "Ophthalmologist", color: "#EF4444" },
  { id: "s5", name: "Ethan Tittler MD", role: "Ophthalmologist", color: "#8B5CF6" },
  { id: "s6", name: "Ken Miselis MD", role: "Ophthalmologist", color: "#EC4899" },
  { id: "s7", name: "Kelsey McCall OD", role: "Optometrist", color: "#06B6D4" },
  { id: "s8", name: "Vik Girn OD", role: "Optometrist", color: "#84CC16" },
  { id: "s9", name: "Angela Maharaj OD", role: "Optometrist", color: "#F97316" },
  { id: "s10", name: "Mike Sakamoto MD", role: "Ophthalmologist", color: "#6366F1" },
];

const PRESET_LOCATIONS = [
  { id: "l1", name: "Manteca", address: "" },
  { id: "l2", name: "Stockton", address: "" },
  { id: "l5", name: "Modesto", address: "" },
  { id: "l6", name: "Turlock", address: "" },
  { id: "l7", name: "VLSC", address: "Valley Laser Surgery Center" },
  { id: "l8", name: "MSC", address: "Modesto Surgery Center" },
  { id: "l9", name: "DHM", address: "Doctors Hospital Manteca" },
  { id: "l10", name: "LVC", address: "LASIK Surgery" },
  { id: "l11", name: "NCSC", address: "NorCal Surgery Center" },
  { id: "l12", name: "SJLSC", address: "San Joaquin Laser and Surgery Center" },
  { id: "l13", name: "Admin", address: "" },
  { id: "l14", name: "VA", address: "Veterans Affairs" },
];

// Distinct muted colors for location sections in calendar cells
const LOCATION_COLORS = {
  l1:  { bg: '#1a2332', border: '#2d6a9f', text: '#5ba3d9' },  // Manteca - blue
  l2:  { bg: '#1a2a22', border: '#2d8f5f', text: '#4ec990' },  // Stockton - green
  l5:  { bg: '#2a1f2e', border: '#8f4fc0', text: '#b47de0' },  // Modesto - purple
  l6:  { bg: '#2a2518', border: '#9f8030', text: '#d4b04a' },  // Turlock - gold
  l7:  { bg: '#1f1520', border: '#c04070', text: '#e06090' },  // VLSC - rose
  l8:  { bg: '#201a18', border: '#b06030', text: '#d08050' },  // MSC - orange
  l9:  { bg: '#18202a', border: '#4080c0', text: '#60a0e0' },  // DHM - sky
  l10: { bg: '#1f1520', border: '#c04070', text: '#e06090' },  // LVC - rose
  l11: { bg: '#1a2025', border: '#3090a0', text: '#50c0d0' },  // NCSC - teal
  l12: { bg: '#201a28', border: '#7050b0', text: '#9070d0' },  // SJLSC - indigo
  l13: { bg: '#1a1a20', border: '#606070', text: '#8888a0' },  // Admin - grey
  l14: { bg: '#1a2520', border: '#308060', text: '#50b080' },  // VA - sea green
  OFF: { bg: '#15151f', border: '#333340', text: '#555565' },   // OFF - dim
};

// ============================================================
// PRESET RULES â€” All doctor scheduling rules
// weekOfMonth: "all" | comma-separated "1,2,3,4"
// period: "both" | "am" | "pm"
// ============================================================
const PRESET_RULES = [
  // ===== DR. KIM (s1) =====
  { id:"pr1", staffId:"s1", dayOfWeek:"Mon", weekOfMonth:"all", period:"both", locationId:"l1", priority:"required", ruleType:"standard", description:"Manteca Clinic every Monday" },
  { id:"pr2", staffId:"s1", dayOfWeek:"Tue", weekOfMonth:"1,2,4", period:"both", locationId:"l5", priority:"required", ruleType:"standard", description:"Modesto Clinic on 1st, 2nd & 4th Tuesdays" },
  { id:"pr3", staffId:"s1", dayOfWeek:"Tue", weekOfMonth:"3", period:"both", locationId:"l8", priority:"required", ruleType:"standard", description:"MSC on 3rd Tuesday" },
  { id:"pr4", staffId:"s1", dayOfWeek:"Wed", weekOfMonth:"all", period:"both", locationId:"l2", priority:"required", ruleType:"standard", description:"Stockton Clinic every Wednesday" },
  { id:"pr5", staffId:"s1", dayOfWeek:"Thu", weekOfMonth:"1,2,4", period:"both", locationId:"l7", priority:"preferred", ruleType:"standard", description:"VLSC on 1st, 2nd & 4th Thursdays (based on surgical need)" },
  { id:"pr6", staffId:"s1", dayOfWeek:"Thu", weekOfMonth:"3", period:"both", locationId:"l2", priority:"preferred", ruleType:"conditional", conditionText:"Stockton Clinic or Off â€” based on other provider schedules and surgical needs", description:"3rd Thu: flexible" },
  { id:"pr7", staffId:"s1", dayOfWeek:"Fri", weekOfMonth:"1", period:"both", locationId:"l6", priority:"required", ruleType:"exception", exceptionText:"If 1st Friday falls on 1st of month AND Dr. Tittler was NOT in surgery the day before â†’ move to 2nd Friday and notify Turlock Eye Care", description:"1st Friday = Turlock" },
  { id:"pr8", staffId:"s1", dayOfWeek:"Fri", weekOfMonth:"2,3,4", period:"both", locationId:"OFF", priority:"preferred", ruleType:"standard", description:"Off every other Friday (alternating)" },

  // ===== DR. LIN (s2) =====
  { id:"pr9", staffId:"s2", dayOfWeek:"Mon", weekOfMonth:"all", period:"both", locationId:"OFF", priority:"preferred", ruleType:"exception", exceptionText:"Every other month when an extra MSC day is needed â†’ assign to MSC instead of OFF", description:"Off Mondays unless extra MSC needed" },
  { id:"pr10", staffId:"s2", dayOfWeek:"Tue", weekOfMonth:"1", period:"both", locationId:"l8", priority:"required", ruleType:"standard", description:"MSC on 1st Tuesday" },
  { id:"pr11", staffId:"s2", dayOfWeek:"Tue", weekOfMonth:"2", period:"both", locationId:"l1", priority:"required", ruleType:"standard", description:"Manteca Clinic on 2nd Tuesday" },
  { id:"pr12", staffId:"s2", dayOfWeek:"Tue", weekOfMonth:"3", period:"both", locationId:"l5", priority:"required", ruleType:"standard", description:"Modesto Clinic on 3rd Tuesday" },
  { id:"pr13", staffId:"s2", dayOfWeek:"Tue", weekOfMonth:"4", period:"both", locationId:"l12", priority:"required", ruleType:"standard", description:"SJLSC on 4th Tuesday" },
  { id:"pr14", staffId:"s2", dayOfWeek:"Wed", weekOfMonth:"all", period:"both", locationId:"l7", priority:"preferred", ruleType:"standard", description:"VLSC every Wednesday (unless low case count)" },
  { id:"pr15", staffId:"s2", dayOfWeek:"Thu", weekOfMonth:"1", period:"both", locationId:"l5", priority:"required", ruleType:"standard", description:"Modesto Clinic on 1st Thursday" },
  { id:"pr16", staffId:"s2", dayOfWeek:"Thu", weekOfMonth:"2", period:"both", locationId:"l2", priority:"required", ruleType:"standard", description:"Stockton Clinic on 2nd Thursday" },
  { id:"pr17", staffId:"s2", dayOfWeek:"Thu", weekOfMonth:"3", period:"am", locationId:"l2", priority:"required", ruleType:"standard", description:"3rd Thu AM = Stockton Clinic" },
  { id:"pr18", staffId:"s2", dayOfWeek:"Thu", weekOfMonth:"3", period:"pm", locationId:"l10", priority:"required", ruleType:"standard", description:"3rd Thu PM = LASIK Surgery (LVC)" },
  { id:"pr19", staffId:"s2", dayOfWeek:"Thu", weekOfMonth:"4", period:"both", locationId:"l5", priority:"preferred", ruleType:"standard", description:"4th Thu = Open/flexible. Prefer extra Modesto day" },
  { id:"pr19b", staffId:"s2", dayOfWeek:"Thu", weekOfMonth:"all", period:"both", locationId:"l2", priority:"preferred", ruleType:"negative", negativeText:"Does NOT want 3 Stockton Thursdays in a month. Maximum 2 Stockton Thursdays.", description:"Negative: max 2 Stockton Thursdays" },
  { id:"pr20", staffId:"s2", dayOfWeek:"Fri", weekOfMonth:"all", period:"both", locationId:"OFF", priority:"required", ruleType:"standard", description:"Off every Friday" },

  // ===== DR. CHOI (s3) =====
  { id:"pr21", staffId:"s3", dayOfWeek:"Mon", weekOfMonth:"1,2,3", period:"both", locationId:"l7", priority:"required", ruleType:"standard", description:"VLSC surgery on 1stâ€“3rd Mondays" },
  { id:"pr22", staffId:"s3", dayOfWeek:"Mon", weekOfMonth:"4", period:"both", locationId:"l8", priority:"preferred", ruleType:"conditional", conditionText:"Extra MSC day if needed, otherwise VLSC or Stockton Clinic based on coverage needs", description:"4th Mon: flexible" },
  { id:"pr23", staffId:"s3", dayOfWeek:"Tue", weekOfMonth:"all", period:"both", locationId:"l2", priority:"required", ruleType:"standard", description:"Stockton Clinic every Tuesday" },
  { id:"pr24", staffId:"s3", dayOfWeek:"Wed", weekOfMonth:"1,2,3", period:"both", locationId:"l1", priority:"required", ruleType:"standard", description:"Manteca Clinic on 1stâ€“3rd Wednesdays" },
  { id:"pr25", staffId:"s3", dayOfWeek:"Wed", weekOfMonth:"4", period:"both", locationId:"l8", priority:"required", ruleType:"standard", description:"MSC on 4th Wednesday" },
  { id:"pr26", staffId:"s3", dayOfWeek:"Thu", weekOfMonth:"1", period:"both", locationId:"l9", priority:"preferred", ruleType:"rotation", rotateWithStaffId:"s4", rotateAtLocationId:"l9", description:"1st Thu: DHM rotation with Dr. Yang. If not DHM â†’ Stockton Clinic" },
  { id:"pr27", staffId:"s3", dayOfWeek:"Thu", weekOfMonth:"2,3", period:"both", locationId:"l5", priority:"required", ruleType:"standard", description:"Modesto Clinic on 2nd & 3rd Thursdays" },
  { id:"pr28", staffId:"s3", dayOfWeek:"Thu", weekOfMonth:"4", period:"both", locationId:"l1", priority:"required", ruleType:"standard", description:"Manteca Clinic on 4th Thursday" },
  { id:"pr29", staffId:"s3", dayOfWeek:"Fri", weekOfMonth:"1", period:"both", locationId:"l14", priority:"required", ruleType:"standard", description:"VA on 1st Friday" },
  { id:"pr30", staffId:"s3", dayOfWeek:"Fri", weekOfMonth:"2,3,4", period:"both", locationId:"l5", priority:"required", ruleType:"standard", description:"Modesto Clinic on 2ndâ€“4th Fridays" },

  // ===== DR. YANG (s4) =====
  { id:"pr31", staffId:"s4", dayOfWeek:"Mon", weekOfMonth:"1", period:"both", locationId:"l13", priority:"preferred", ruleType:"standard", description:"1st Mon = Admin Day (unless moved by request)" },
  { id:"pr32", staffId:"s4", dayOfWeek:"Mon", weekOfMonth:"2", period:"both", locationId:"l2", priority:"required", ruleType:"standard", description:"Stockton Clinic on 2nd Monday" },
  { id:"pr33", staffId:"s4", dayOfWeek:"Mon", weekOfMonth:"3,4", period:"both", locationId:"l2", priority:"preferred", ruleType:"conditional", conditionText:"If Dr. Tittler has no other Modesto days available this week â†’ rotate Modesto with Tittler; otherwise Stockton Clinic", description:"3rd & 4th Mon: conditional Modesto/Stockton" },
  { id:"pr34", staffId:"s4", dayOfWeek:"Tue", weekOfMonth:"1", period:"both", locationId:"l1", priority:"required", ruleType:"standard", description:"Manteca Clinic on 1st Tuesday" },
  { id:"pr35", staffId:"s4", dayOfWeek:"Tue", weekOfMonth:"2,3", period:"both", locationId:"l7", priority:"preferred", ruleType:"conditional", conditionText:"Rotate VLSC OR coordinate with Dr. Tittler if Tittler needs VLSC coverage", description:"2nd & 3rd Tue: VLSC coordination with Tittler" },
  { id:"pr36", staffId:"s4", dayOfWeek:"Wed", weekOfMonth:"1,2,4", period:"both", locationId:"l2", priority:"preferred", ruleType:"conditional", conditionText:"Stockton Clinic by default. IF Dr. Lin has unused OR days â†’ assign Yang to VLSC instead", description:"Wed: Stockton or VLSC based on Lin's OR schedule" },
  { id:"pr37", staffId:"s4", dayOfWeek:"Wed", weekOfMonth:"3", period:"both", locationId:"l8", priority:"required", ruleType:"standard", description:"MSC on 3rd Wednesday" },
  { id:"pr38", staffId:"s4", dayOfWeek:"Thu", weekOfMonth:"1", period:"both", locationId:"l9", priority:"preferred", ruleType:"rotation", rotateWithStaffId:"s3", rotateAtLocationId:"l9", description:"1st Thu: DHM rotation with Dr. Choi. If not DHM â†’ Manteca Clinic" },
  { id:"pr39", staffId:"s4", dayOfWeek:"Thu", weekOfMonth:"2,3", period:"both", locationId:"l1", priority:"required", ruleType:"standard", description:"Manteca Clinic on 2nd & 3rd Thursdays" },
  { id:"pr40", staffId:"s4", dayOfWeek:"Thu", weekOfMonth:"4", period:"both", locationId:"l2", priority:"preferred", ruleType:"conditional", conditionText:"Stockton Clinic, usually if Dr. Lin is in Modesto that day", description:"4th Thu: Stockton (conditional on Lin)" },
  { id:"pr41", staffId:"s4", dayOfWeek:"Fri", weekOfMonth:"1", period:"both", locationId:"l5", priority:"required", ruleType:"standard", description:"Modesto Clinic on 1st Friday" },
  { id:"pr42", staffId:"s4", dayOfWeek:"Fri", weekOfMonth:"2,3", period:"both", locationId:"l2", priority:"preferred", ruleType:"conditional", conditionText:"Stockton if Yang was in Manteca the Thursday prior; otherwise flexible", description:"2nd & 3rd Fri: based on prior day" },
  { id:"pr43", staffId:"s4", dayOfWeek:"Fri", weekOfMonth:"4", period:"both", locationId:"l1", priority:"preferred", ruleType:"conditional", conditionText:"Manteca if Yang was in Stockton the Thursday prior; otherwise flexible", description:"4th Fri: based on prior day" },

  // ===== DR. TITTLER (s5) =====
  { id:"pr44", staffId:"s5", dayOfWeek:"Mon", weekOfMonth:"1,2,3", period:"both", locationId:"l5", priority:"required", ruleType:"standard", description:"Modesto Clinic on 1stâ€“3rd Mondays" },
  { id:"pr45", staffId:"s5", dayOfWeek:"Mon", weekOfMonth:"4", period:"both", locationId:"l5", priority:"preferred", ruleType:"conditional", conditionText:"Based on Dr. Yang's Modesto needs â€” if Yang needs Modesto, Tittler may go to extra MSC day instead", description:"4th Mon: conditional on Yang's schedule" },
  { id:"pr46", staffId:"s5", dayOfWeek:"Tue", weekOfMonth:"1", period:"both", locationId:"l7", priority:"required", ruleType:"standard", description:"VLSC on 1st Tuesday" },
  { id:"pr47", staffId:"s5", dayOfWeek:"Tue", weekOfMonth:"2", period:"both", locationId:"l2", priority:"required", ruleType:"standard", description:"Stockton Clinic on 2nd Tuesday" },
  { id:"pr48", staffId:"s5", dayOfWeek:"Tue", weekOfMonth:"3", period:"both", locationId:"l1", priority:"required", ruleType:"standard", description:"Manteca Clinic on 3rd Tuesday" },
  { id:"pr49", staffId:"s5", dayOfWeek:"Tue", weekOfMonth:"4", period:"both", locationId:"l7", priority:"required", ruleType:"standard", description:"VLSC on 4th Tuesday" },
  { id:"pr50", staffId:"s5", dayOfWeek:"Wed", weekOfMonth:"1,2", period:"both", locationId:"l8", priority:"required", ruleType:"standard", description:"MSC on 1st & 2nd Wednesdays" },
  { id:"pr51", staffId:"s5", dayOfWeek:"Wed", weekOfMonth:"3", period:"both", locationId:"l6", priority:"required", ruleType:"standard", description:"Turlock on 3rd Wednesday" },
  { id:"pr52", staffId:"s5", dayOfWeek:"Wed", weekOfMonth:"4", period:"both", locationId:"l1", priority:"required", ruleType:"standard", description:"Manteca Clinic on 4th Wednesday" },
  { id:"pr53", staffId:"s5", dayOfWeek:"Thu", weekOfMonth:"1", period:"both", locationId:"l8", priority:"required", ruleType:"standard", description:"MSC on 1st Thursday" },
  { id:"pr54", staffId:"s5", dayOfWeek:"Thu", weekOfMonth:"2,3", period:"both", locationId:"l2", priority:"required", ruleType:"standard", description:"Stockton Clinic on 2nd & 3rd Thursdays" },
  { id:"pr55", staffId:"s5", dayOfWeek:"Thu", weekOfMonth:"4", period:"both", locationId:"l9", priority:"required", ruleType:"standard", description:"DHM on 4th Thursday" },
  { id:"pr56", staffId:"s5", dayOfWeek:"Fri", weekOfMonth:"all", period:"both", locationId:"l7", priority:"preferred", ruleType:"complex", description:"Fridays: Make-up clinic / VLSC / NCSC (Merced) depending on month needs and surgical backlog" },

  // ===== DR. SAKAMOTO (s10) =====
  { id:"pr57", staffId:"s10", dayOfWeek:"Wed", weekOfMonth:"all", period:"both", locationId:"l5", priority:"required", ruleType:"standard", description:"Modesto Clinic every Wednesday (1stâ€“4th)" },

  // ===== DR. MISELIS (s6) =====
  { id:"pr58", staffId:"s6", dayOfWeek:"Mon", weekOfMonth:"all", period:"both", locationId:"l2", priority:"required", ruleType:"standard", description:"Stockton Clinic every Monday" },
  { id:"pr59", staffId:"s6", dayOfWeek:"Tue", weekOfMonth:"all", period:"both", locationId:"l2", priority:"required", ruleType:"standard", description:"Stockton Clinic every Tuesday" },
  { id:"pr60", staffId:"s6", dayOfWeek:"Wed", weekOfMonth:"all", period:"both", locationId:"l2", priority:"required", ruleType:"standard", description:"Stockton Clinic every Wednesday" },

  // ===== DR. McCALL (s7) =====
  { id:"pr61", staffId:"s7", dayOfWeek:"Mon", weekOfMonth:"all", period:"both", locationId:"l2", priority:"required", ruleType:"standard", description:"Stockton Clinic every Monday" },
  { id:"pr62", staffId:"s7", dayOfWeek:"Tue", weekOfMonth:"all", period:"am", locationId:"l2", priority:"required", ruleType:"standard", description:"Stockton Clinic every Tuesday AM" },
  { id:"pr63", staffId:"s7", dayOfWeek:"Tue", weekOfMonth:"all", period:"pm", locationId:"l2", priority:"required", ruleType:"standard", description:"Stockton Clinic every Tuesday PM" },
  { id:"pr64", staffId:"s7", dayOfWeek:"Wed", weekOfMonth:"1", period:"both", locationId:"l5", priority:"preferred", ruleType:"conditional", conditionText:"Modesto Clinic IF Dr. Lin was at MSC the day before (Tuesday); otherwise Stockton", description:"1st Wed: Modesto if Lin was at MSC Tue" },
  { id:"pr65", staffId:"s7", dayOfWeek:"Thu", weekOfMonth:"1", period:"both", locationId:"l2", priority:"required", ruleType:"standard", description:"Stockton Clinic on 1st Thursday" },
  { id:"pr66", staffId:"s7", dayOfWeek:"Thu", weekOfMonth:"2,4", period:"both", locationId:"l5", priority:"preferred", ruleType:"conditional", conditionText:"Modesto Clinic if a surgeon was at MSC the day prior (Wednesday); otherwise Stockton", description:"2nd & 4th Thu: Modesto if surgeon at MSC Wed" },
  { id:"pr67", staffId:"s7", dayOfWeek:"Thu", weekOfMonth:"3", period:"both", locationId:"l1", priority:"required", ruleType:"standard", description:"Manteca Clinic on 3rd Thursday" },
  { id:"pr68", staffId:"s7", dayOfWeek:"Fri", weekOfMonth:"all", period:"both", locationId:"l2", priority:"required", ruleType:"standard", description:"Stockton Clinic every Friday" },

  // ===== DR. MAHARAJ (s9) =====
  { id:"pr69", staffId:"s9", dayOfWeek:"Wed", weekOfMonth:"all", period:"both", locationId:"l2", priority:"required", ruleType:"exception", exceptionText:"Unless needed for Manteca coverage due to staff shortages", description:"Stockton Clinic every Wednesday" },
  { id:"pr70", staffId:"s9", dayOfWeek:"Thu", weekOfMonth:"all", period:"both", locationId:"l2", priority:"required", ruleType:"exception", exceptionText:"Unless needed for Manteca coverage due to staff shortages", description:"Stockton Clinic every Thursday" },
  { id:"pr71", staffId:"s9", dayOfWeek:"Fri", weekOfMonth:"all", period:"both", locationId:"l2", priority:"required", ruleType:"exception", exceptionText:"Unless needed for Manteca coverage due to staff shortages", description:"Stockton Clinic every Friday" },

  // ===== DR. GIRN (s8) =====
  { id:"pr72", staffId:"s8", dayOfWeek:"Mon", weekOfMonth:"all", period:"both", locationId:"l1", priority:"preferred", ruleType:"exception", exceptionText:"Unless Stockton coverage is needed due to other provider absences", description:"Manteca Clinic every Monday" },
  { id:"pr73", staffId:"s8", dayOfWeek:"Tue", weekOfMonth:"1,2,3", period:"both", locationId:"l1", priority:"required", ruleType:"standard", description:"Manteca Clinic on 1stâ€“3rd Tuesdays" },
  { id:"pr74", staffId:"s8", dayOfWeek:"Tue", weekOfMonth:"4", period:"both", locationId:"l5", priority:"required", ruleType:"standard", description:"Modesto Clinic on 4th Tuesday" },
  { id:"pr75", staffId:"s8", dayOfWeek:"Wed", weekOfMonth:"all", period:"both", locationId:"l13", priority:"preferred", ruleType:"exception", exceptionText:"Unless coverage is needed at another clinic", description:"Admin Day every Wednesday" },
  { id:"pr76", staffId:"s8", dayOfWeek:"Thu", weekOfMonth:"1,2,4", period:"both", locationId:"l1", priority:"required", ruleType:"standard", description:"Manteca Clinic on 1st, 2nd & 4th Thursdays" },
  { id:"pr77", staffId:"s8", dayOfWeek:"Thu", weekOfMonth:"3", period:"both", locationId:"l2", priority:"required", ruleType:"standard", description:"Stockton Clinic on 3rd Thursday" },
  { id:"pr78", staffId:"s8", dayOfWeek:"Fri", weekOfMonth:"all", period:"both", locationId:"l1", priority:"required", ruleType:"standard", description:"Manteca Clinic every Friday" },
];

// Holiday definitions â€” type: "fixed" (month/day) or "nth" (nth weekday of month) or "lastMon" (last Monday)
// month is 0-indexed (0=Jan, 11=Dec)
// halfDay: "am" means office open AM only, closed PM. "closed" (default) means fully closed.
const PRESET_HOLIDAYS = [
  { id: 'h1', name: 'New Year\'s Day', type: 'fixed', month: 0, day: 1, halfDay: 'closed', note: '' },
  { id: 'h1b', name: 'New Year\'s Eve', type: 'fixed', month: 11, day: 31, halfDay: 'am', note: 'Office open AM only â€” closes at noon' },
  { id: 'h2', name: 'Presidents Day', type: 'nth', month: 1, nth: 3, weekday: 1, halfDay: 'closed', note: '' },
  { id: 'h3', name: 'Memorial Day', type: 'lastMon', month: 4, halfDay: 'closed', note: '' },
  { id: 'h4', name: 'Independence Day', type: 'fixed', month: 6, day: 4, halfDay: 'closed', note: '' },
  { id: 'h5', name: 'Labor Day', type: 'nth', month: 8, nth: 1, weekday: 1, halfDay: 'closed', note: '' },
  { id: 'h6', name: 'Thanksgiving Day', type: 'nth', month: 10, nth: 4, weekday: 4, halfDay: 'closed', note: '' },
  { id: 'h7', name: 'Day After Thanksgiving', type: 'nthPlus', month: 10, nth: 4, weekday: 4, plusDays: 1, halfDay: 'closed', note: '' },
  { id: 'h8', name: 'Christmas Day', type: 'fixed', month: 11, day: 25, halfDay: 'closed', note: '' },
  { id: 'h8b', name: 'Christmas Eve', type: 'fixed', month: 11, day: 24, halfDay: 'am', note: 'Office open AM only â€” closes at noon' },
];

// Compute the actual date for a holiday in a given year
function getHolidayDate(h, year) {
  if (h.type === 'fixed') return new Date(year, h.month, h.day);
  if (h.type === 'nth') {
    // nth weekday of month (e.g., 3rd Monday of Feb)
    let count = 0;
    for (let d = 1; d <= 31; d++) {
      const dt = new Date(year, h.month, d);
      if (dt.getMonth() !== h.month) break;
      if (dt.getDay() === h.weekday) { count++; if (count === h.nth) return dt; }
    }
  }
  if (h.type === 'lastMon') {
    // Last Monday of month
    const last = new Date(year, h.month + 1, 0);
    for (let d = last.getDate(); d >= 1; d--) {
      const dt = new Date(year, h.month, d);
      if (dt.getDay() === 1) return dt;
    }
  }
  if (h.type === 'nthPlus') {
    // nth weekday + plusDays (e.g., day after Thanksgiving)
    let count = 0;
    for (let d = 1; d <= 31; d++) {
      const dt = new Date(year, h.month, d);
      if (dt.getMonth() !== h.month) break;
      if (dt.getDay() === h.weekday) { count++; if (count === h.nth) { dt.setDate(dt.getDate() + h.plusDays); return dt; } }
    }
  }
  return null;
}

function getCalendarDays(year, month) {
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const days = [];
  for (let i = 0; i < firstDay; i++) days.push(null);
  for (let i = 1; i <= daysInMonth; i++) days.push(i);
  return days;
}

function dateKey(year, month, day) {
  return `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
}

function isWeekend(year, month, day) {
  return [0, 6].includes(new Date(year, month, day).getDay());
}

// Get which week-of-month (1-5) a given day falls on
function getWeekOfMonth(day) {
  return Math.ceil(day / 7);
}

function Modal({ open, onClose, title, children, wide }) {
  if (!open) return null;
  return (
    <div style={{position:'fixed',inset:0,zIndex:1000,display:'flex',alignItems:'center',justifyContent:'center',background:'rgba(0,0,0,0.5)',backdropFilter:'blur(4px)'}} onClick={onClose}>
      <div onClick={e=>e.stopPropagation()} style={{background:'#1a1a2e',border:'1px solid #2a2a4a',borderRadius:16,padding:32,minWidth:wide?700:420,maxWidth:wide?900:520,maxHeight:'85vh',overflow:'auto',boxShadow:'0 24px 64px rgba(0,0,0,0.5)'}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:24}}>
          <h3 style={{margin:0,fontSize:20,color:'#e8e8f0',fontFamily:'"DM Sans",sans-serif',fontWeight:600}}>{title}</h3>
          <button onClick={onClose} style={{background:'none',border:'none',color:'#888',fontSize:22,cursor:'pointer',padding:4}}>âœ•</button>
        </div>
        {children}
      </div>
    </div>
  );
}

function Input({ label, value, onChange, placeholder, type = "text", style: sx }) {
  return (
    <div style={{marginBottom:16,...sx}}>
      {label && <label style={{display:'block',fontSize:12,color:'#9ca3af',marginBottom:6,fontFamily:'"DM Sans",sans-serif',textTransform:'uppercase',letterSpacing:'0.05em'}}>{label}</label>}
      <input type={type} value={value} onChange={e => onChange(e.target.value)} placeholder={placeholder}
        style={{width:'100%',padding:'10px 14px',background:'#12121f',border:'1px solid #2a2a4a',borderRadius:8,color:'#e8e8f0',fontSize:14,fontFamily:'"DM Sans",sans-serif',outline:'none',boxSizing:'border-box'}} />
    </div>
  );
}

function Textarea({ label, value, onChange, placeholder, rows=3 }) {
  return (
    <div style={{marginBottom:16}}>
      {label && <label style={{display:'block',fontSize:12,color:'#9ca3af',marginBottom:6,fontFamily:'"DM Sans",sans-serif',textTransform:'uppercase',letterSpacing:'0.05em'}}>{label}</label>}
      <textarea value={value} onChange={e => onChange(e.target.value)} placeholder={placeholder} rows={rows}
        style={{width:'100%',padding:'10px 14px',background:'#12121f',border:'1px solid #2a2a4a',borderRadius:8,color:'#e8e8f0',fontSize:14,fontFamily:'"DM Sans",sans-serif',outline:'none',boxSizing:'border-box',resize:'vertical'}} />
    </div>
  );
}

function Select({ label, value, onChange, options }) {
  return (
    <div style={{marginBottom:16}}>
      {label && <label style={{display:'block',fontSize:12,color:'#9ca3af',marginBottom:6,fontFamily:'"DM Sans",sans-serif',textTransform:'uppercase',letterSpacing:'0.05em'}}>{label}</label>}
      <select value={value} onChange={e => onChange(e.target.value)}
        style={{width:'100%',padding:'10px 14px',background:'#12121f',border:'1px solid #2a2a4a',borderRadius:8,color:'#e8e8f0',fontSize:14,fontFamily:'"DM Sans",sans-serif',outline:'none',boxSizing:'border-box'}}>
        {options.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
      </select>
    </div>
  );
}

function Btn({ children, onClick, variant = "primary", style: sx, disabled }) {
  const base = {padding:'10px 20px',borderRadius:8,border:'none',fontSize:13,fontWeight:600,cursor:disabled?'not-allowed':'pointer',fontFamily:'"DM Sans",sans-serif',transition:'all 0.2s',opacity:disabled?0.5:1,...sx};
  const variants = {
    primary:{background:'linear-gradient(135deg,#6366f1,#8b5cf6)',color:'#fff'},
    secondary:{background:'#2a2a4a',color:'#e8e8f0'},
    danger:{background:'#dc2626',color:'#fff'},
    ghost:{background:'transparent',color:'#9ca3af',border:'1px solid #2a2a4a'},
    success:{background:'linear-gradient(135deg,#059669,#10b981)',color:'#fff'},
    dev:{background:'linear-gradient(135deg,#b45309,#d97706)',color:'#fff'},
  };
  return <button onClick={onClick} disabled={disabled} style={{...base,...variants[variant]}}>{children}</button>;
}

function Chip({ children, color }) {
  return (
    <span style={{display:'inline-flex',alignItems:'center',gap:6,padding:'4px 12px',borderRadius:20,background:color+'22',color:color,fontSize:12,fontWeight:600,fontFamily:'"DM Sans",sans-serif'}}>
      {children}
    </span>
  );
}

// Week-of-month toggle component
function WeekOfMonthPicker({ value, onChange }) {
  const weeks = ["1","2","3","4"];
  const selected = value === "all" ? ["1","2","3","4"] : value.split(",");
  const isAll = selected.length === 4;

  function toggle(w) {
    let next;
    if (selected.includes(w)) {
      next = selected.filter(x => x !== w);
      if (next.length === 0) next = [w]; // must have at least one
    } else {
      next = [...selected, w].sort();
    }
    onChange(next.length === 4 ? "all" : next.join(","));
  }

  function toggleAll() {
    onChange(isAll ? "1" : "all");
  }

  const labels = { "1": "1st", "2": "2nd", "3": "3rd", "4": "4th" };

  return (
    <div style={{marginBottom:16}}>
      <label style={{display:'block',fontSize:12,color:'#9ca3af',marginBottom:8,fontFamily:'"DM Sans",sans-serif',textTransform:'uppercase',letterSpacing:'0.05em'}}>Week of Month</label>
      <div style={{display:'flex',gap:8,flexWrap:'wrap'}}>
        <div onClick={toggleAll}
          style={{padding:'8px 16px',borderRadius:8,cursor:'pointer',fontSize:13,fontWeight:600,fontFamily:'"DM Sans",sans-serif',
            background:isAll?'#6366f122':'#12121f',color:isAll?'#818cf8':'#6b7280',border:`1px solid ${isAll?'#6366f1':'#2a2a4a'}`,transition:'all 0.15s'}}>
          All Weeks
        </div>
        {weeks.map(w => {
          const active = selected.includes(w);
          return (
            <div key={w} onClick={() => toggle(w)}
              style={{padding:'8px 16px',borderRadius:8,cursor:'pointer',fontSize:13,fontWeight:600,fontFamily:'"DM Sans",sans-serif',
                background:active?'#6366f122':'#12121f',color:active?'#818cf8':'#6b7280',border:`1px solid ${active?'#6366f1':'#2a2a4a'}`,transition:'all 0.15s'}}>
              {labels[w]}
            </div>
          );
        })}
      </div>
    </div>
  );
}

// Format weekOfMonth for display
function formatWeekOfMonth(wom) {
  if (wom === "all") return "Every week";
  const labels = { "1": "1st", "2": "2nd", "3": "3rd", "4": "4th" };
  return wom.split(",").map(w => labels[w] || w).join(", ");
}

// ============================================================
// MAIN APP
// ============================================================
window.ScheduleHelper = function StaffScheduler() {
  const [loading, setLoading] = useState(true);
  const [user, setUser] = useState(null);
  const [isDev, setIsDev] = useState(false);
  const [loginForm, setLoginForm] = useState({ username: '', password: '', isRegister: false });

  const [staff, setStaff] = useState([]);
  const [locations, setLocations] = useState([]);
  const [rules, setRules] = useState([]);
  const [vacations, setVacations] = useState([]);
  const [holidays, setHolidays] = useState([]);
  const [schedules, setSchedules] = useState({});
  const scheduleHistoryRef = useRef([]);
  const scheduleHistoryIndexRef = useRef(-1);
  const [canUndo, setCanUndo] = useState(false);
  const [canRedo, setCanRedo] = useState(false);

  function pushScheduleHistory(prevSchedules) {
    // Trim any redo history beyond current index
    scheduleHistoryRef.current = scheduleHistoryRef.current.slice(0, scheduleHistoryIndexRef.current + 1);
    scheduleHistoryRef.current.push(JSON.parse(JSON.stringify(prevSchedules)));
    // Cap at 50 entries
    if (scheduleHistoryRef.current.length > 50) scheduleHistoryRef.current.shift();
    scheduleHistoryIndexRef.current = scheduleHistoryRef.current.length - 1;
    setCanUndo(scheduleHistoryIndexRef.current > 0);
    setCanRedo(false);
  }

  function undoSchedule() {
    if (scheduleHistoryIndexRef.current <= 0) return;
    scheduleHistoryIndexRef.current -= 1;
    const prev = JSON.parse(JSON.stringify(scheduleHistoryRef.current[scheduleHistoryIndexRef.current]));
    setSchedules(prev);
    setCanUndo(scheduleHistoryIndexRef.current > 0);
    setCanRedo(true);
  }

  function redoSchedule() {
    if (scheduleHistoryIndexRef.current >= scheduleHistoryRef.current.length - 1) return;
    scheduleHistoryIndexRef.current += 1;
    const next = JSON.parse(JSON.stringify(scheduleHistoryRef.current[scheduleHistoryIndexRef.current]));
    setSchedules(next);
    setCanUndo(true);
    setCanRedo(scheduleHistoryIndexRef.current < scheduleHistoryRef.current.length - 1);
  }

  const [currentMonth, setCurrentMonth] = useState(new Date().getMonth());
  const [currentYear, setCurrentYear] = useState(new Date().getFullYear());
  const [activeTab, setActiveTab] = useState('schedule');
  const [editCell, setEditCell] = useState(null);
  const [generating, setGenerating] = useState(false);
  const [aiLog, setAiLog] = useState('');
  const [conflictsReport, setConflictsReport] = useState(null); // {conflicts:[], month, year}
  const [rulesFilter, setRulesFilter] = useState('all');
  const [devLogs, setDevLogs] = useState([]);
  const [showLogs, setShowLogs] = useState(true);
  const [visibleStaff, setVisibleStaff] = useState(new Set());
  const [visibleLocations, setVisibleLocations] = useState(new Set());
  const [expandedLocation, setExpandedLocation] = useState(null);
  const [expandedStaffMember, setExpandedStaffMember] = useState(null);
  const [calendarView, setCalendarView] = useState('month'); // 'month' | 'week'
  const [currentWeekStart, setCurrentWeekStart] = useState(null); // Date of Monday

  // Plan system: A, B, C per month
  const [activePlan, setActivePlan] = useState('A');
  const [finalPlans, setFinalPlans] = useState({}); // { "2026-1": "A", ... }

  // AI Agent chat
  const [chatMessages, setChatMessages] = useState([]);
  const [chatInput, setChatInput] = useState('');
  const [chatLoading, setChatLoading] = useState(false);
  const [showChat, setShowChat] = useState(false);

  // AI generation: pause/resume for critical ambiguities
  const [genAmbiguities, setGenAmbiguities] = useState(null); // [{question, options, id}]
  const [genAmbiguityAnswers, setGenAmbiguityAnswers] = useState({}); // {id: answer}
  const [genPendingContext, setGenPendingContext] = useState(null); // saved context for resume
  const [showPdfMenu, setShowPdfMenu] = useState(false);

  // Call Claude API via Netlify function (API key stays server-side)
  async function callClaudeAPI(body) {
    return fetch('/.netlify/functions/claude-proxy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
  }

  const logsEndRef = useRef(null);
  const chatEndRef = useRef(null);

  // Initialize visibleStaff and visibleLocations to show all when data loads
  useEffect(() => {
    if (staff.length > 0 && visibleStaff.size === 0) {
      setVisibleStaff(new Set(staff.map(s => s.id)));
    }
  }, [staff]);

  useEffect(() => {
    if (locations.length > 0 && visibleLocations.size === 0) {
      setVisibleLocations(new Set(locations.map(l => l.id)));
    }
  }, [locations]);

  // Get last name (handles "Steve Kim MD" â†’ "Kim", "Kelsey McCall OD" â†’ "McCall")
  const RULE_TYPE_BADGES = {standard:'ðŸ“‹',conditional:'ðŸ”€',exception:'âš ï¸',negative:'ðŸš«',rotation:'ðŸ”„',complex:'ðŸ“'};
  function ruleTypeBadge(r) {
    const rt = r.ruleType || 'standard';
    if (rt === 'standard') return null;
    const colors = {conditional:'#f59e0b',exception:'#ef4444',negative:'#ec4899',rotation:'#10b981',complex:'#8b5cf6'};
    return React.createElement('span',{style:{fontSize:10,fontWeight:700,color:colors[rt]||'#6b7280',background:(colors[rt]||'#6b7280')+'22',padding:'1px 6px',borderRadius:4,marginLeft:6}}, (RULE_TYPE_BADGES[rt]||'') + ' ' + rt);
  }

  function getLastName(fullName) {
    const parts = fullName.split(' ');
    const suffixes = ['MD', 'OD', 'DO', 'NP', 'PA', 'RN', 'Jr', 'Sr', 'II', 'III'];
    // Find last non-suffix part
    for (let i = parts.length - 1; i >= 0; i--) {
      if (!suffixes.includes(parts[i].replace(/[.,]/g, ''))) return parts[i];
    }
    return parts[0];
  }

  function toggleStaffVisibility(id) {
    setVisibleStaff(prev => {
      const next = new Set(prev);
      if (next.has(id)) next.delete(id); else next.add(id);
      return next;
    });
  }

  function showAllStaff() { setVisibleStaff(new Set(staff.map(s => s.id))); }
  function showNoneStaff() { setVisibleStaff(new Set()); }

  function toggleLocationVisibility(id) {
    setVisibleLocations(prev => {
      const next = new Set(prev);
      if (next.has(id)) next.delete(id); else next.add(id);
      return next;
    });
  }
  function showAllLocations() { setVisibleLocations(new Set(locations.map(l => l.id))); }
  function showNoneLocations() { setVisibleLocations(new Set()); }

  function addLog(type, message, data) {
    const entry = { time: new Date().toLocaleTimeString(), type, message, data: data ? JSON.stringify(data).substring(0, 2000) : null };
    setDevLogs(prev => [...prev, entry]);
  }

  useEffect(() => {
    if (logsEndRef.current) logsEndRef.current.scrollIntoView({ behavior: 'smooth' });
  }, [devLogs]);

  const [showStaffModal, setShowStaffModal] = useState(false);
  const [showLocationModal, setShowLocationModal] = useState(false);
  const [showRuleModal, setShowRuleModal] = useState(false);
  const [showVacationModal, setShowVacationModal] = useState(false);
  const [editingStaff, setEditingStaff] = useState(null);
  const [editingRule, setEditingRule] = useState(null);
  const [editingLocation, setEditingLocation] = useState(null);

  const [staffForm, setStaffForm] = useState({ name:'', role:'', color:defaultColors[0] });
  const [locationForm, setLocationForm] = useState({ name:'', address:'' });
  const [ruleForm, setRuleForm] = useState({ staffId:'', dayOfWeek:'Mon', weekOfMonth:'all', period:'both', locationId:'', priority:'preferred', description:'', ruleType:'standard', conditionText:'', exceptionText:'', negativeText:'', rotateWithStaffId:'', rotateAtLocationId:'' });
  const [vacationForm, setVacationForm] = useState({ staffId:'', startDate:'', endDate:'', reason:'' });
  const [showHolidayModal, setShowHolidayModal] = useState(false);
  const [editingHoliday, setEditingHoliday] = useState(null);
  const [holidayForm, setHolidayForm] = useState({ name:'', month:0, day:1, halfDay:'closed', note:'' });

  const scheduleKey = `schedule-${currentYear}-${currentMonth}-${activePlan}`;
  const monthKey = `${currentYear}-${currentMonth}`;

  const finalPlanForMonth = finalPlans[monthKey] || null;

  function setFinalPlan(plan) {
    setFinalPlans(prev => ({ ...prev, [monthKey]: plan }));
  }
  function clearFinalPlan() {
    setFinalPlans(prev => { const n = { ...prev }; delete n[monthKey]; return n; });
  }

  function planHasData(plan) {
    const key = `schedule-${currentYear}-${currentMonth}-${plan}`;
    return schedules[key] && Object.keys(schedules[key]).length > 0;
  }

  function copyPlanTo(fromPlan, toPlan) {
    const fromKey = `schedule-${currentYear}-${currentMonth}-${fromPlan}`;
    const toKey = `schedule-${currentYear}-${currentMonth}-${toPlan}`;
    const data = schedules[fromKey];
    if (!data) return;
    setSchedules(prev => ({ ...prev, [toKey]: JSON.parse(JSON.stringify(data)) }));
  }

  useEffect(() => {
    (async () => {
      try {
        const sess = await window.storage.get('session');
        if (sess) {
          const u = JSON.parse(sess.value);
          setUser(u);
          setIsDev(u.isDev || false);

          if (u.isDev) {
            // For dev account, verify all presets exist before loading
            let hasCompleteData = false;
            try {
              const staffData = await window.storage.get(`${u.username}:staff`);
              const locData = await window.storage.get(`${u.username}:locations`);
              const rulesData = await window.storage.get(`${u.username}:rules`);
              const staffOk = staffData && JSON.parse(staffData.value).length > 0;
              const locsOk = locData && JSON.parse(locData.value).length > 0;
              const rulesOk = rulesData && JSON.parse(rulesData.value).length > 0;
              hasCompleteData = staffOk && locsOk && rulesOk;
            } catch(e) {}

            if (!hasCompleteData) {
              // Restore presets but keep vacations and schedules
              let existingVacations = [];
              let existingSchedules = {};
              try {
                const vacData = await window.storage.get(`${u.username}:vacations`);
                if (vacData) existingVacations = JSON.parse(vacData.value);
                const schedData = await window.storage.get(`${u.username}:schedules`);
                if (schedData) existingSchedules = JSON.parse(schedData.value);
              } catch(e) {}
              setStaff(PRESET_STAFF); setLocations(PRESET_LOCATIONS); setRules(PRESET_RULES); setHolidays(PRESET_HOLIDAYS);
              setVacations(existingVacations); setSchedules(existingSchedules);
              await window.storage.set(`${u.username}:staff`, JSON.stringify(PRESET_STAFF));
              await window.storage.set(`${u.username}:locations`, JSON.stringify(PRESET_LOCATIONS));
              await window.storage.set(`${u.username}:rules`, JSON.stringify(PRESET_RULES));
              await window.storage.set(`${u.username}:holidays`, JSON.stringify(PRESET_HOLIDAYS));
            } else {
              await loadUserData(u.username);
            }
          } else {
            await loadUserData(u.username);
          }
        }
      } catch(e) {}
      setLoading(false);
    })();
  }, []);

  async function loadUserData(username) {
    try {
      const d = async k => { try { const r = await window.storage.get(`${username}:${k}`); return r ? JSON.parse(r.value) : null; } catch(e) { return null; } };
      const s = await d('staff'); if (s) setStaff(s);
      let l = await d('locations');
      let r = await d('rules');
      let sc = await d('schedules');

      // Migration: consolidate Stockton LASIK (l3) and Stockton LAL (l4) â†’ Stockton (l2)
      const deprecatedLocs = ['l3', 'l4'];
      if (l) {
        l = l.filter(loc => !deprecatedLocs.includes(loc.id));
        setLocations(l);
      }
      if (r) {
        r = r.map(rule => deprecatedLocs.includes(rule.locationId) ? { ...rule, locationId: 'l2' } : rule);
        setRules(r);
      }
      if (sc) {
        // Migrate schedule assignments
        const migrated = {};
        for (const [schedKey, days] of Object.entries(sc)) {
          migrated[schedKey] = {};
          for (const [dayKey, staffAssigns] of Object.entries(days)) {
            migrated[schedKey][dayKey] = {};
            for (const [staffId, periods] of Object.entries(staffAssigns)) {
              migrated[schedKey][dayKey][staffId] = {};
              for (const [period, locId] of Object.entries(periods)) {
                migrated[schedKey][dayKey][staffId][period] = deprecatedLocs.includes(locId) ? 'l2' : locId;
              }
            }
          }
        }
        setSchedules(migrated);
      }

      const v = await d('vacations'); if (v) setVacations(v);
      const h = await d('holidays'); if (h) setHolidays(h); else setHolidays(PRESET_HOLIDAYS);
      const fp = await d('finalPlans'); if (fp) setFinalPlans(fp);
    } catch(e) {}
  }

  async function saveData(key, data) {
    if (!user) return;
    try { await window.storage.set(`${user.username}:${key}`, JSON.stringify(data)); } catch(e) {}
  }

  useEffect(() => { if (user) saveData('staff', staff); }, [staff]);
  useEffect(() => { if (user) saveData('locations', locations); }, [locations]);
  useEffect(() => { if (user) saveData('rules', rules); }, [rules]);
  useEffect(() => { if (user) saveData('vacations', vacations); }, [vacations]);
  useEffect(() => { if (user) saveData('holidays', holidays); }, [holidays]);
  useEffect(() => { if (user) saveData('schedules', schedules); }, [schedules]);
  useEffect(() => { if (user) saveData('finalPlans', finalPlans); }, [finalPlans]);

  useEffect(() => {
    if (chatEndRef.current) chatEndRef.current.scrollIntoView({ behavior: 'smooth' });
  }, [chatMessages]);

  useEffect(() => {
    if (!showPdfMenu) return;
    const handler = (e) => { if (!e.target.closest('[data-pdf-menu]')) setShowPdfMenu(false); };
    document.addEventListener('click', handler, true);
    return () => document.removeEventListener('click', handler, true);
  }, [showPdfMenu]);

  async function handleAuth() {
    const { username, password, isRegister } = loginForm;
    if (!username || !password) return;
    if (isRegister) {
      try { const existing = await window.storage.get(`user:${username}`); if (existing) { alert('Username taken'); return; } } catch(e) {}
      const u = { username, created: Date.now() };
      await window.storage.set(`user:${username}`, JSON.stringify({ ...u, password }));
      await window.storage.set('session', JSON.stringify(u));
      setUser(u); setIsDev(false);
    } else {
      try {
        const userData = await window.storage.get(`user:${username}`);
        if (!userData) { alert('User not found'); return; }
        const parsed = JSON.parse(userData.value);
        if (parsed.password !== password) { alert('Wrong password'); return; }
        const u = { username, created: parsed.created };
        await window.storage.set('session', JSON.stringify(u));
        setUser(u); setIsDev(false);
        await loadUserData(username);
      } catch(e) { alert('Login failed'); }
    }
  }

  async function handleDevLogin() {
    const devPw = prompt('Developer password:');
    if (devPw !== DEV_PASSWORD) { alert('Wrong password'); return; }
    const u = { username: DEV_USERNAME, isDev: true, created: Date.now() };
    await window.storage.set('session', JSON.stringify(u));
    setUser(u); setIsDev(true);

    // Check if ALL essential preset data exists (staff, locations, AND rules)
    let hasCompleteData = false;
    try {
      const staffData = await window.storage.get(`${DEV_USERNAME}:staff`);
      const locData = await window.storage.get(`${DEV_USERNAME}:locations`);
      const rulesData = await window.storage.get(`${DEV_USERNAME}:rules`);

      const staffOk = staffData && JSON.parse(staffData.value).length > 0;
      const locsOk = locData && JSON.parse(locData.value).length > 0;
      const rulesOk = rulesData && JSON.parse(rulesData.value).length > 0;

      hasCompleteData = staffOk && locsOk && rulesOk;
    } catch(e) {}

    if (!hasCompleteData) {
      // Initialize with all presets â€” keep any existing vacations and schedules
      let existingVacations = [];
      let existingSchedules = {};
      try {
        const vacData = await window.storage.get(`${DEV_USERNAME}:vacations`);
        if (vacData) existingVacations = JSON.parse(vacData.value);
        const schedData = await window.storage.get(`${DEV_USERNAME}:schedules`);
        if (schedData) existingSchedules = JSON.parse(schedData.value);
      } catch(e) {}

      setStaff(PRESET_STAFF); setLocations(PRESET_LOCATIONS); setRules(PRESET_RULES); setHolidays(PRESET_HOLIDAYS);
      setVacations(existingVacations); setSchedules(existingSchedules);
      await window.storage.set(`${DEV_USERNAME}:staff`, JSON.stringify(PRESET_STAFF));
      await window.storage.set(`${DEV_USERNAME}:locations`, JSON.stringify(PRESET_LOCATIONS));
      await window.storage.set(`${DEV_USERNAME}:rules`, JSON.stringify(PRESET_RULES));
      await window.storage.set(`${DEV_USERNAME}:holidays`, JSON.stringify(PRESET_HOLIDAYS));
    } else {
      await loadUserData(DEV_USERNAME);
    }
    await ensureCveAccount();
  }

  async function resetDevData() {
    if (!confirm('Reset all data to presets? This will clear schedules, vacations, and restore default staff, locations & rules.')) return;
    setStaff(PRESET_STAFF); setLocations(PRESET_LOCATIONS); setRules(PRESET_RULES); setHolidays(PRESET_HOLIDAYS); setVacations([]); setSchedules({});
    await window.storage.set(`${DEV_USERNAME}:staff`, JSON.stringify(PRESET_STAFF));
    await window.storage.set(`${DEV_USERNAME}:locations`, JSON.stringify(PRESET_LOCATIONS));
    await window.storage.set(`${DEV_USERNAME}:rules`, JSON.stringify(PRESET_RULES));
    await window.storage.set(`${DEV_USERNAME}:holidays`, JSON.stringify(PRESET_HOLIDAYS));
    await window.storage.set(`${DEV_USERNAME}:vacations`, JSON.stringify([]));
    await window.storage.set(`${DEV_USERNAME}:schedules`, JSON.stringify({}));

  // Ensure CVE user account exists with a copy of dev data
  async function ensureCveAccount() {
    const CVE_USER = 'cve';
    const CVE_PASS = 'brandy';
    try { await window.storage.get(`user:${CVE_USER}`); return; } catch(e) {} // already exists
    // Create user record
    await window.storage.set(`user:${CVE_USER}`, JSON.stringify({ username: CVE_USER, password: CVE_PASS, created: Date.now() }));
    // Copy all dev data to cve namespace
    const keys = ['staff','locations','rules','holidays','vacations','schedules','finalPlans'];
    for (const key of keys) {
      try {
        const data = await window.storage.get(`${DEV_USERNAME}:${key}`);
        if (data) await window.storage.set(`${CVE_USER}:${key}`, data.value);
      } catch(e) {}
    }
  }
  }

  async function logout() {
    try { await window.storage.delete('session'); } catch(e) {}
    setUser(null); setIsDev(false);
    setStaff([]); setLocations([]); setRules([]); setVacations([]); setHolidays([]); setSchedules({});
  }

  function addStaff() {
    if (!staffForm.name) return;
    if (editingStaff) { setStaff(prev => prev.map(s => s.id === editingStaff.id ? { ...s, ...staffForm } : s)); setEditingStaff(null); }
    else { setStaff(prev => [...prev, { id: 's' + Date.now(), ...staffForm }]); }
    setStaffForm({ name:'', role:'', color:defaultColors[staff.length%defaultColors.length] }); setShowStaffModal(false);
  }
  function removeStaff(id) { if (!confirm('Remove this staff member and all their rules/vacations?')) return; setStaff(p=>p.filter(s=>s.id!==id)); setRules(p=>p.filter(r=>r.staffId!==id)); setVacations(p=>p.filter(v=>v.staffId!==id)); }
  function addLocation() {
    if (!locationForm.name) return;
    if (editingLocation) { setLocations(prev => prev.map(l => l.id === editingLocation.id ? { ...l, ...locationForm } : l)); setEditingLocation(null); }
    else { setLocations(prev => [...prev, { id: 'l' + Date.now(), ...locationForm }]); }
    setLocationForm({ name:'', address:'' }); setShowLocationModal(false);
  }
  function removeLocation(id) { if (!confirm('Remove this location?')) return; setLocations(p=>p.filter(l=>l.id!==id)); setRules(p=>p.filter(r=>r.locationId!==id)); }
  function addRule() {
    if (!ruleForm.staffId) return;
    // Standard/conditional/exception rules need locationId; negative/rotation/complex may not
    if (ruleForm.ruleType === 'standard' && !ruleForm.locationId) return;
    if (editingRule) { setRules(prev => prev.map(r => r.id === editingRule.id ? { ...r, ...ruleForm } : r)); setEditingRule(null); }
    else { setRules(prev => [...prev, { id: 'r' + Date.now(), ...ruleForm }]); }
    resetRuleForm(); setShowRuleModal(false);
  }
  function resetRuleForm(overrides) {
    setRuleForm({ staffId:staff[0]?.id||'', dayOfWeek:'Mon', weekOfMonth:'all', period:'both', locationId:locations[0]?.id||'', priority:'preferred', description:'', ruleType:'standard', conditionText:'', exceptionText:'', negativeText:'', rotateWithStaffId:'', rotateAtLocationId:'', ...(overrides||{}) });
  }
  function removeRule(id) { setRules(prev => prev.filter(r => r.id !== id)); }
  function addVacation() {
    if (!vacationForm.staffId || !vacationForm.startDate || !vacationForm.endDate) return;
    setVacations(prev => [...prev, { id: 'v' + Date.now(), ...vacationForm }]);
    setVacationForm({ staffId:staff[0]?.id||'', startDate:'', endDate:'', reason:'' }); setShowVacationModal(false);
  }
  function removeVacation(id) { setVacations(prev => prev.filter(v => v.id !== id)); }
  function isOnVacation(staffId, dateStr) { return vacations.some(v => v.staffId === staffId && dateStr >= v.startDate && dateStr <= v.endDate); }

  function addHoliday() {
    if (!holidayForm.name) return;
    if (editingHoliday) {
      setHolidays(prev => prev.map(h => h.id === editingHoliday.id ? { ...editingHoliday, name:holidayForm.name, month:holidayForm.month, day:holidayForm.day, halfDay:holidayForm.halfDay, note:holidayForm.note } : h));
      setEditingHoliday(null);
    } else {
      setHolidays(prev => [...prev, { id: 'h' + Date.now(), type: 'fixed', ...holidayForm }]);
    }
    setHolidayForm({ name:'', month:0, day:1, halfDay:'closed', note:'' }); setShowHolidayModal(false);
  }
  function removeHoliday(id) { setHolidays(prev => prev.filter(h => h.id !== id)); }

  // Check if a given date (year, month 0-indexed, day) falls on a holiday
  function getHolidayForDate(year, month, day) {
    const dk = dateKey(year, month, day);
    for (const h of holidays) {
      const hd = getHolidayDate(h, year);
      if (!hd) continue;
      const hdk = dateKey(hd.getFullYear(), hd.getMonth(), hd.getDate());
      if (hdk === dk) return h;
    }
    return null;
  }

  function getSchedule() { return schedules[scheduleKey] || {}; }

  function setDayAssignment(day, staffId, period, locationId) {
    const dk = dateKey(currentYear, currentMonth, day);
    setSchedules(prev => {
      pushScheduleHistory(prev);
      const sched = { ...prev };
      if (!sched[scheduleKey]) sched[scheduleKey] = {};
      if (!sched[scheduleKey][dk]) sched[scheduleKey][dk] = {};
      if (!sched[scheduleKey][dk][staffId]) sched[scheduleKey][dk][staffId] = {};
      sched[scheduleKey][dk][staffId][period] = locationId;
      return { ...sched };
    });
  }

  function clearSchedule() {
    if (!confirm('Clear entire schedule for this month?')) return;
    setSchedules(prev => { const s = { ...prev }; delete s[scheduleKey]; return s; });
  }

  // Build a human-readable rules summary for the AI prompt
  function buildRulesSummary() {
    const grouped = {};
    rules.forEach(r => {
      const s = staff.find(x => x.id === r.staffId);
      if (!s) return;
      if (!grouped[s.name]) grouped[s.name] = [];
      const l = locations.find(x => x.id === r.locationId);
      const locName = r.locationId === 'OFF' ? 'OFF' : (l?.name || '?');
      const womLabel = formatWeekOfMonth(r.weekOfMonth);
      const periodLabel = r.period === 'both' ? 'Full Day' : r.period.toUpperCase();
      const rType = r.ruleType || 'standard';

      let line = '';
      if (rType === 'standard') {
        line = `${r.dayOfWeek} [${womLabel}] ${periodLabel} â†’ ${locName} (${r.priority})${r.description ? ' â€” ' + r.description : ''}`;
      } else if (rType === 'conditional') {
        line = `[CONDITIONAL] ${r.dayOfWeek} [${womLabel}] â†’ ${locName} (${r.priority}) IF: ${r.conditionText || r.description || '(no condition)'}`;
      } else if (rType === 'exception') {
        line = `${r.dayOfWeek} [${womLabel}] ${periodLabel} â†’ ${locName} (${r.priority}) EXCEPTION: ${r.exceptionText || r.description || '(no exception)'}`;
      } else if (rType === 'negative') {
        line = `[NEGATIVE CONSTRAINT] ${r.negativeText || r.description || '(no constraint)'}`;
      } else if (rType === 'rotation') {
        const rotateWith = staff.find(x => x.id === r.rotateWithStaffId);
        const rotateLoc = locations.find(x => x.id === r.rotateAtLocationId);
        line = `[ROTATION] ${r.dayOfWeek} [${womLabel}] â€” Rotates monthly with ${rotateWith?.name || '?'} at ${rotateLoc?.name || locName} â€” Check previous month to determine whose turn`;
      } else if (rType === 'complex') {
        line = `[COMPLEX RULE] ${r.description || '(no description)'}`;
      }
      grouped[s.name].push(line);
    });

    let summary = '';
    for (const [name, ruleList] of Object.entries(grouped)) {
      summary += `\n${name}:\n`;
      ruleList.forEach(r => { summary += `  â€¢ ${r}\n`; });
    }
    return summary || 'No rules defined.';
  }

  // Get previous month's finalized schedule for cross-month context
  function getPreviousMonthContext() {
    let prevMonth = currentMonth - 1;
    let prevYear = currentYear;
    if (prevMonth < 0) { prevMonth = 11; prevYear--; }

    const prevMonthKey = `${prevYear}-${prevMonth}`;
    const prevFinalPlan = finalPlans[prevMonthKey];

    if (!prevFinalPlan) {
      return 'No finalized schedule found for previous month (' + MONTHS[prevMonth] + ' ' + prevYear + '). Use best judgment for rotations and cross-month dependencies.';
    }

    const prevScheduleKey = `schedule-${prevYear}-${prevMonth}-${prevFinalPlan}`;
    const prevSchedule = schedules[prevScheduleKey];
    if (!prevSchedule || Object.keys(prevSchedule).length === 0) {
      return 'Previous month (' + MONTHS[prevMonth] + ' ' + prevYear + ') has a finalized plan (' + prevFinalPlan + ') but no schedule data found.';
    }

    // Summarize last week of previous month
    const prevDays = new Date(prevYear, prevMonth + 1, 0).getDate();
    const lastWeekStart = Math.max(prevDays - 6, 1);
    let summary = `PREVIOUS MONTH CONTEXT (${MONTHS[prevMonth]} ${prevYear}, Plan ${prevFinalPlan}):\n`;
    summary += `Last week assignments (for rotation/dependency tracking):\n`;

    for (let d = lastWeekStart; d <= prevDays; d++) {
      const dk = dateKey(prevYear, prevMonth, d);
      const ds = prevSchedule[dk];
      if (!ds) continue;
      const dow = new Date(prevYear, prevMonth, d).getDay();
      if (dow === 0 || dow === 6) continue;
      summary += `  ${dk} (${DAYS_OF_WEEK[dow]}):\n`;
      for (const [sid, periods] of Object.entries(ds)) {
        const s = staff.find(x => x.id === sid);
        if (!s) continue;
        const amLoc = periods.am === 'OFF' ? 'OFF' : (locations.find(l => l.id === periods.am)?.name || periods.am);
        const pmLoc = periods.pm === 'OFF' ? 'OFF' : (locations.find(l => l.id === periods.pm)?.name || periods.pm);
        if (amLoc === pmLoc) summary += `    ${s.name}: ${amLoc}\n`;
        else summary += `    ${s.name}: AM=${amLoc}, PM=${pmLoc}\n`;
      }
    }

    // Identify rotation-relevant facts
    const rotationRules = rules.filter(r => (r.ruleType || 'standard') === 'rotation');
    if (rotationRules.length > 0) {
      summary += `\nROTATION STATUS (based on previous month):\n`;
      rotationRules.forEach(r => {
        const s = staff.find(x => x.id === r.staffId);
        const rotateWith = staff.find(x => x.id === r.rotateWithStaffId);
        const rotateLoc = locations.find(x => x.id === (r.rotateAtLocationId || r.locationId));
        if (!s || !rotateWith || !rotateLoc) return;
        // Check who was at the rotation location in previous month
        let wasThereLastMonth = 'unknown';
        for (let d = 1; d <= prevDays; d++) {
          const dk = dateKey(prevYear, prevMonth, d);
          const ds = prevSchedule[dk];
          if (!ds) continue;
          if (ds[s.id]?.am === rotateLoc.id || ds[s.id]?.pm === rotateLoc.id) wasThereLastMonth = s.name;
          if (ds[rotateWith.id]?.am === rotateLoc.id || ds[rotateWith.id]?.pm === rotateLoc.id) wasThereLastMonth = rotateWith.name;
        }
        summary += `  ${s.name} / ${rotateWith.name} rotation at ${rotateLoc.name}: Last month it was ${wasThereLastMonth}'s turn â†’ This month should be ${wasThereLastMonth === s.name ? rotateWith.name : s.name}'s turn\n`;
      });
    }

    return summary;
  }

  async function generateWithAI(userDecisions) {
    if (staff.length === 0 || locations.length === 0) { alert('Please add staff members and locations first.'); return; }
    setGenerating(true);
    setGenAmbiguities(null);
    addLog('info', 'Starting AI schedule generation (biweekly batches)...');

    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const rulesSummary = buildRulesSummary();
    const prevMonthContext = getPreviousMonthContext();

    // Group weekdays into biweekly batches (W1+W2, W3+W4, overflow)
    const allWeekdays = [];
    for (let d = 1; d <= daysInMonth; d++) {
      const dow = new Date(currentYear, currentMonth, d).getDay();
      if (dow >= 1 && dow <= 5) allWeekdays.push(d);
    }

    // Split into weekly batches (W1=days 1-7, W2=8-14, W3=15-21, W4=22+)
    const weekBounds = [[1,7],[8,14],[15,21],[22,daysInMonth]];
    const batches = weekBounds.map((wb, wi) => ({
      days: allWeekdays.filter(d => d >= wb[0] && d <= wb[1]),
      label: `W${wi+1}`
    })).filter(b => b.days.length > 0);

    const decisionsBlock = userDecisions ? `\nUSER DECISIONS (from critical ambiguity prompts):\n${Object.entries(userDecisions).map(([k,v]) => `- ${k}: ${v}`).join('\n')}\nFollow these decisions exactly.\n` : '';

    const contextBlock = `You are an expert staff scheduling assistant for a multi-location ophthalmology/optometry practice.

MONTH: ${MONTHS[currentMonth]} ${currentYear} (${daysInMonth} days)
The 1st falls on ${DAYS_OF_WEEK[new Date(currentYear, currentMonth, 1).getDay()]}.

STAFF MEMBERS:
${staff.map(s => `- ${s.name} (ID: ${s.id}, Role: ${s.role})`).join('\n')}

LOCATIONS:
${locations.map(l => `- ${l.name} (ID: ${l.id})`).join('\n')}

${prevMonthContext}

SCHEDULING RULES (by provider):
${rulesSummary}

VACATION / OUT OF OFFICE:
${vacations.length > 0 ? vacations.map(v => {
  const s = staff.find(x => x.id === v.staffId);
  return `- ${s?.name || '?'}: ${v.startDate} to ${v.endDate}`;
}).join('\n') : 'None.'}

COMPANY HOLIDAYS:
${(()=>{
  const hols = [];
  holidays.forEach(h => {
    const dt = getHolidayDate(h, currentYear);
    if (!dt || dt.getMonth() !== currentMonth) return;
    const dk = dateKey(dt.getFullYear(), dt.getMonth(), dt.getDate());
    hols.push('- ' + dk + ': ' + h.name + (h.halfDay === 'am' ? ' (AM only, PM OFF)' : ' (CLOSED â€” all OFF)'));
  });
  return hols.length > 0 ? hols.join('\n') : 'None this month.';
})()}
${decisionsBlock}
RULES:
- "Week of month": days 1-7=W1, 8-14=W2, 15-21=W3, 22+=W4.
- Follow REQUIRED rules strictly. PREFERRED when possible.
- Cross-provider dependencies: pay attention to rotations and conditional rules.
- For ROTATION rules: check the PREVIOUS MONTH CONTEXT to determine whose turn it is.
- For CONDITIONAL rules: evaluate the condition and apply accordingly.
- For EXCEPTION rules: apply the base rule UNLESS the exception condition is met.
- For NEGATIVE CONSTRAINT rules: ensure the constraint is satisfied (e.g., "no more than 2 Stockton Thursdays").
- No rule or "OFF" â†’ mark OFF. Vacation â†’ OFF both AM/PM.
- Holidays CLOSED â†’ OFF both. Half-day â†’ schedule AM, OFF PM.
- 5th occurrence of a weekday â†’ use W4 rules.`;

    addLog('info', `Context: ${contextBlock.length} chars, ${allWeekdays.length} weekdays, ${batches.length} batches`);

    const allAssignments = {};
    const allAmbiguities = [];
    const allAutoResolved = [];
    let totalDays = 0;

    for (let bi = 0; bi < batches.length; bi++) {
      const batchDays = batches[bi].days;
      const batchLabel = batches[bi].label;
      setAiLog(`â³ Generating ${batchLabel} (${batchDays.length} days)... batch ${bi + 1} of ${batches.length}`);

      const daysList = batchDays.map(d => {
        const dt = new Date(currentYear, currentMonth, d);
        const wk = Math.min(Math.floor((d - 1) / 7), 3) + 1;
        return `${dateKey(currentYear, currentMonth, d)} (${DAYS_OF_WEEK[dt.getDay()]}, W${wk})`;
      }).join(', ');

      // Carry forward prior-week results for cross-week dependency accuracy
      let priorWeeksBlock = '';
      if (bi > 0 && Object.keys(allAssignments).length > 0) {
        priorWeeksBlock = '\nPRIOR WEEKS ALREADY SCHEDULED (for cross-day dependencies):\n';
        const priorDays = Object.keys(allAssignments).sort().slice(-5); // last 5 days max
        priorDays.forEach(dk => {
          const dayData = allAssignments[dk];
          const d = parseInt(dk.split('-')[2]);
          const dow = new Date(currentYear, currentMonth, d).getDay();
          priorWeeksBlock += `  ${dk} (${DAYS_OF_WEEK[dow]}):\n`;
          Object.entries(dayData).forEach(([sid, periods]) => {
            const s = staff.find(x => x.id === sid);
            if (!s) return;
            const amLoc = periods.am === 'OFF' ? 'OFF' : (locations.find(l => l.id === periods.am)?.name || periods.am);
            const pmLoc = periods.pm === 'OFF' ? 'OFF' : (locations.find(l => l.id === periods.pm)?.name || periods.pm);
            priorWeeksBlock += `    ${s.name}: ${amLoc === pmLoc ? amLoc : 'AM=' + amLoc + ', PM=' + pmLoc}\n`;
          });
        });
        priorWeeksBlock += 'Use this to inform conditional rules that depend on prior days.\n';
      }

      const batchPrompt = `${contextBlock}
${priorWeeksBlock}

TASK: Generate schedule for ONLY these days: ${daysList}

For each day, assign EVERY staff member an AM and PM location (or "OFF").
Respond ONLY with valid JSON, no markdown, no backticks:
{
  "assignments": {
    "YYYY-MM-DD": {
      "staffId": { "am": "locationId_or_OFF", "pm": "locationId_or_OFF" }
    }
  },
  "ambiguities": [
    { "id": "unique_id", "severity": "critical|minor", "question": "description of ambiguity", "chose": "what you chose and why", "alternatives": ["option A", "option B"] }
  ],
  "auto_resolved": [
    { "description": "what minor conflict was auto-resolved and how" }
  ]
}
Use exact IDs. Include every listed day and every staff member.
For CRITICAL ambiguities (e.g., rotation with no previous month data, contradictory required rules, unclear conditional): list them so the user can decide.
For MINOR ambiguities (e.g., preferred rule couldn't be met, small scheduling preference): auto-resolve with your best judgment and list in auto_resolved.`;

      addLog('request', `Batch ${bi+1} (${batchLabel}): ${batchDays.length} days, prompt ${batchPrompt.length} chars`);

      try {
        const response = await callClaudeAPI({
          model: "claude-sonnet-4-6",
          max_tokens: 4096,
          messages: [{ role: "user", content: batchPrompt }]
        });

        addLog('response', `Batch ${bi+1}: HTTP ${response.status}`, { ok: response.ok });

        if (!response.ok) {
          let errorText = '';
          try { errorText = await response.text(); } catch(e) { errorText = '?'; }
          addLog('error', `Batch ${bi+1} error ${response.status}`, { errorText: errorText.substring(0, 500) });
          setAiLog(`âš ï¸ API error on ${batchLabel} (${response.status}). Check developer logs.`);
          setGenerating(false);
          return;
        }

        const rawText = await response.text();
        const data = JSON.parse(rawText);

        if (data.error) {
          addLog('error', `Batch ${bi+1} API error`, { error: data.error });
          setAiLog(`âš ï¸ Error on ${batchLabel}: ${data.error?.message || 'Unknown'}`);
          setGenerating(false);
          return;
        }

        const text = (data.content || []).map(i => i.type === 'text' ? (i.text || '') : '').join('');
        const clean = text.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();

        let parsed;
        try {
          parsed = JSON.parse(clean);
        } catch(e) {
          const m = clean.match(/\{[\s\S]*\}/);
          if (m) parsed = JSON.parse(m[0]);
          else throw e;
        }

        const dayData = parsed.assignments || parsed;
        Object.assign(allAssignments, dayData);
        totalDays += Object.keys(dayData).length;

        // Collect ambiguities and auto-resolved
        if (parsed.ambiguities) allAmbiguities.push(...parsed.ambiguities);
        if (parsed.auto_resolved) allAutoResolved.push(...parsed.auto_resolved);

        addLog('success', `Batch ${bi+1} (${batchLabel}): ${Object.keys(dayData).length} days${parsed.ambiguities?.length ? ', ' + parsed.ambiguities.length + ' ambiguities' : ''}`);


      } catch (err) {
        addLog('error', `Batch ${bi+1} failed: ${err.message}`);
        setAiLog(`âš ï¸ Failed on ${batchLabel}: ${err.message}`);
        setGenerating(false);
        return;
      }
    }

    // Post-process: enforce holidays
    let holidayEdits = 0;
    for (const [dk, dayAssignments] of Object.entries(allAssignments)) {
      const [y, m, d] = dk.split('-').map(Number);
      const holiday = getHolidayForDate(y, m - 1, d);
      if (!holiday) continue;
      for (const sid of Object.keys(dayAssignments)) {
        if (holiday.halfDay === 'am') {
          if (dayAssignments[sid].pm !== 'OFF') { dayAssignments[sid].pm = 'OFF'; holidayEdits++; }
        } else {
          if (dayAssignments[sid].am !== 'OFF' || dayAssignments[sid].pm !== 'OFF') {
            dayAssignments[sid].am = 'OFF'; dayAssignments[sid].pm = 'OFF'; holidayEdits++;
          }
        }
      }
    }
    if (holidayEdits > 0) addLog('info', `Holiday enforcement: ${holidayEdits} corrections`);

    setSchedules(prev => { pushScheduleHistory(prev); return { ...prev, [scheduleKey]: allAssignments }; });
    addLog('success', `Schedule complete: ${totalDays} days in ${batches.length} batches`);

    // Check for critical ambiguities that need user input
    const criticals = allAmbiguities.filter(a => a.severity === 'critical');
    if (criticals.length > 0 && !userDecisions) {
      setGenAmbiguities(criticals);
      setGenPendingContext({ allAssignments, allAmbiguities, allAutoResolved, totalDays, holidayEdits });
      setAiLog(`âš ï¸ ${criticals.length} critical ambiguit${criticals.length > 1 ? 'ies' : 'y'} need${criticals.length === 1 ? 's' : ''} your input. Resolve below to finalize.`);
      setGenerating(false);
      return;
    }

    // Detect rule conflicts/violations
    const conflicts = detectRuleConflicts(allAssignments);
    if (conflicts.length > 0) {
      setConflictsReport({ conflicts, month: currentMonth, year: currentYear });
      addLog('info', `Found ${conflicts.length} potential rule conflicts`);
      setAiLog(`âš ï¸ Schedule generated with ${conflicts.length} conflict${conflicts.length>1?'s':''}. Review below.${allAutoResolved.length > 0 ? ` ${allAutoResolved.length} minor issue${allAutoResolved.length>1?'s':''} auto-resolved.` : ''}${holidayEdits > 0 ? ` ${holidayEdits} holiday corrections.` : ''}`);
    } else {
      setConflictsReport(null);
      setAiLog(`âœ… Schedule generated for ${MONTHS[currentMonth]} ${currentYear}! ${totalDays} days populated â€” no rule conflicts detected.${allAutoResolved.length > 0 ? ` ${allAutoResolved.length} minor issue${allAutoResolved.length>1?'s':''} auto-resolved.` : ''}${holidayEdits > 0 ? ` ${holidayEdits} holiday corrections.` : ''}`);
    }
    if (allAutoResolved.length > 0) {
      allAutoResolved.forEach(ar => addLog('info', `Auto-resolved: ${ar.description}`));
    }
    setGenerating(false);
  }

  // Detect scheduling rule violations
  function detectRuleConflicts(assignments) {
    const conflicts = [];
    for (const [dk, dayAssignments] of Object.entries(assignments)) {
      const [y, m, d] = dk.split('-').map(Number);
      const dt = new Date(y, m - 1, d);
      const dow = dt.getDay();
      if (dow === 0 || dow === 6) continue;
      const dayName = DAYS_OF_WEEK[dow];
      const wk = Math.min(Math.floor((d - 1) / 7), 3) + 1;

      for (const [staffId, periods] of Object.entries(dayAssignments)) {
        const s = staff.find(x => x.id === staffId);
        if (!s) continue;

        // Check if on vacation
        if (isOnVacation(staffId, dk)) {
          if (periods.am !== 'OFF' || periods.pm !== 'OFF') {
            conflicts.push({ date: dk, day: dayName, staff: s.name, type: 'vacation',
              message: `${getLastName(s.name)} is on vacation but scheduled`,
              current: `AM: ${periods.am}, PM: ${periods.pm}`, suggested: 'OFF for both AM and PM' });
          }
          continue;
        }

        // Find applicable rules for this staff/day
        const staffRules = rules.filter(r => r.staffId === staffId && r.dayOfWeek === dayName &&
          (r.weekOfMonth === 'all' || r.weekOfMonth === String(wk)));

        const requiredRules = staffRules.filter(r => r.priority === 'required');

        for (const rule of requiredRules) {
          const loc = locations.find(l => l.id === rule.locationId);
          const locName = loc?.name || rule.locationId;
          const period = rule.period;

          if (period === 'am' || period === 'both') {
            if (periods.am !== rule.locationId && periods.am !== 'OFF') {
              const actualLoc = periods.am === 'OFF' ? 'OFF' : (locations.find(l => l.id === periods.am)?.name || periods.am);
              conflicts.push({ date: dk, day: dayName, week: wk, staff: s.name, staffId, type: 'rule_violation',
                message: `${getLastName(s.name)} should be at ${locName} AM (required) but is at ${actualLoc}`,
                ruleId: rule.id, current: `AM: ${actualLoc}`, suggested: `AM: ${locName}`,
                fix: { date: dk, staffId, period: 'am', locationId: rule.locationId } });
            }
          }
          if (period === 'pm' || period === 'both') {
            if (periods.pm !== rule.locationId && periods.pm !== 'OFF') {
              const actualLoc = periods.pm === 'OFF' ? 'OFF' : (locations.find(l => l.id === periods.pm)?.name || periods.pm);
              conflicts.push({ date: dk, day: dayName, week: wk, staff: s.name, staffId, type: 'rule_violation',
                message: `${getLastName(s.name)} should be at ${locName} PM (required) but is at ${actualLoc}`,
                ruleId: rule.id, current: `PM: ${actualLoc}`, suggested: `PM: ${locName}`,
                fix: { date: dk, staffId, period: 'pm', locationId: rule.locationId } });
            }
          }
        }
      }
    }
    return conflicts;
  }

  function applyConflictFix(fix) {
    setSchedules(prev => {
      pushScheduleHistory(prev);
      const sched = { ...(prev[scheduleKey] || {}) };
      if (!sched[fix.date]) sched[fix.date] = {};
      if (!sched[fix.date][fix.staffId]) sched[fix.date][fix.staffId] = { am: 'OFF', pm: 'OFF' };
      sched[fix.date][fix.staffId][fix.period] = fix.locationId;
      return { ...prev, [scheduleKey]: sched };
    });
  }

  // AI Agent Chat
  // Execute an action command from the AI agent
  function executeAgentAction(action) {
    try {
      switch (action.type) {
        case 'add_vacation': {
          const s = staff.find(x => x.name.toLowerCase().includes(action.staffName?.toLowerCase()) || x.id === action.staffId);
          if (!s) return `âŒ Staff member "${action.staffName}" not found.`;
          if (!action.startDate || !action.endDate) return 'âŒ Missing start or end date.';
          const v = { id: 'v' + Date.now(), staffId: s.id, startDate: action.startDate, endDate: action.endDate, reason: action.reason || 'Vacation' };
          setVacations(prev => [...prev, v]);
          return `âœ… Added vacation for ${s.name}: ${action.startDate} to ${action.endDate}${action.reason ? ' (' + action.reason + ')' : ''}`;
        }
        case 'remove_vacation': {
          const s = staff.find(x => x.name.toLowerCase().includes(action.staffName?.toLowerCase()) || x.id === action.staffId);
          if (!s) return `âŒ Staff member "${action.staffName}" not found.`;
          const matching = vacations.filter(v => v.staffId === s.id && (!action.startDate || v.startDate === action.startDate));
          if (matching.length === 0) return `âŒ No matching vacation found for ${s.name}.`;
          setVacations(prev => prev.filter(v => v.id !== matching[0].id));
          return `âœ… Removed vacation for ${s.name}: ${matching[0].startDate} to ${matching[0].endDate}`;
        }
        case 'add_staff': {
          if (!action.name) return 'âŒ Missing staff name.';
          const newStaff = { id: 's' + Date.now(), name: action.name, role: action.role || 'MD', color: defaultColors[staff.length % defaultColors.length] };
          setStaff(prev => [...prev, newStaff]);
          return `âœ… Added staff: ${action.name} (${newStaff.role})`;
        }
        case 'remove_staff': {
          const s = staff.find(x => x.name.toLowerCase().includes(action.staffName?.toLowerCase()));
          if (!s) return `âŒ Staff member "${action.staffName}" not found.`;
          setStaff(p => p.filter(x => x.id !== s.id));
          setRules(p => p.filter(r => r.staffId !== s.id));
          setVacations(p => p.filter(v => v.staffId !== s.id));
          return `âœ… Removed ${s.name} and all their rules/vacations.`;
        }
        case 'add_location': {
          if (!action.name) return 'âŒ Missing location name.';
          setLocations(prev => [...prev, { id: 'l' + Date.now(), name: action.name, address: action.address || '' }]);
          return `âœ… Added location: ${action.name}`;
        }
        case 'remove_location': {
          const loc = locations.find(l => l.name.toLowerCase().includes(action.name?.toLowerCase()));
          if (!loc) return `âŒ Location "${action.name}" not found.`;
          setLocations(p => p.filter(l => l.id !== loc.id));
          setRules(p => p.filter(r => r.locationId !== loc.id));
          return `âœ… Removed location: ${loc.name}`;
        }
        case 'add_rule': {
          const s = staff.find(x => x.name.toLowerCase().includes(action.staffName?.toLowerCase()));
          const loc = locations.find(l => l.name.toLowerCase().includes(action.locationName?.toLowerCase()));
          if (!s) return `âŒ Staff "${action.staffName}" not found.`;
          if (!loc) return `âŒ Location "${action.locationName}" not found.`;
          const newRule = {
            id: 'r' + Date.now(), staffId: s.id, locationId: loc.id,
            dayOfWeek: action.dayOfWeek || 'Mon', weekOfMonth: action.weekOfMonth || 'all',
            period: action.period || 'both', priority: action.priority || 'preferred',
            description: action.description || ''
          };
          setRules(prev => [...prev, newRule]);
          return `âœ… Added rule: ${s.name} â†’ ${loc.name} on ${newRule.dayOfWeek} (${newRule.weekOfMonth}, ${newRule.period}, ${newRule.priority})`;
        }
        case 'remove_rule': {
          const s = staff.find(x => x.name.toLowerCase().includes(action.staffName?.toLowerCase()));
          if (!s) return `âŒ Staff "${action.staffName}" not found.`;
          const matching = rules.filter(r => r.staffId === s.id &&
            (!action.dayOfWeek || r.dayOfWeek === action.dayOfWeek) &&
            (!action.locationName || locations.find(l => l.id === r.locationId)?.name.toLowerCase().includes(action.locationName.toLowerCase()))
          );
          if (matching.length === 0) return `âŒ No matching rule found.`;
          setRules(prev => prev.filter(r => r.id !== matching[0].id));
          const loc = locations.find(l => l.id === matching[0].locationId);
          return `âœ… Removed rule: ${s.name} â†’ ${loc?.name} on ${matching[0].dayOfWeek}`;
        }
        case 'add_holiday': {
          if (!action.name || action.month == null || !action.day) return 'âŒ Missing holiday details.';
          const newH = { id: 'h' + Date.now(), type: 'fixed', name: action.name, month: action.month, day: action.day, halfDay: action.halfDay || 'closed', note: action.note || '' };
          setHolidays(prev => [...prev, newH]);
          return `âœ… Added holiday: ${action.name} (${MONTHS[action.month]} ${action.day})`;
        }
        case 'remove_holiday': {
          const h = holidays.find(x => x.name.toLowerCase().includes(action.name?.toLowerCase()));
          if (!h) return `âŒ Holiday "${action.name}" not found.`;
          setHolidays(prev => prev.filter(x => x.id !== h.id));
          return `âœ… Removed holiday: ${h.name}`;
        }
        case 'update_schedule': {
          const s = staff.find(x => x.name.toLowerCase().includes(action.staffName?.toLowerCase()));
          if (!s) return `âŒ Staff "${action.staffName}" not found.`;
          if (!action.date) return 'âŒ Missing date.';
          const loc = action.location === 'OFF' ? 'OFF' : locations.find(l => l.name.toLowerCase().includes(action.location?.toLowerCase()));
          const locId = action.location === 'OFF' ? 'OFF' : loc?.id;
          if (!locId) return `âŒ Location "${action.location}" not found.`;
          const period = action.period || 'both';
          setSchedules(prev => {
            pushScheduleHistory(prev);
            const sched = { ...prev[scheduleKey] || {} };
            if (!sched[action.date]) sched[action.date] = {};
            if (!sched[action.date][s.id]) sched[action.date][s.id] = { am: 'OFF', pm: 'OFF' };
            if (period === 'am' || period === 'both') sched[action.date][s.id].am = locId;
            if (period === 'pm' || period === 'both') sched[action.date][s.id].pm = locId;
            return { ...prev, [scheduleKey]: sched };
          });
          return `âœ… Updated ${s.name} on ${action.date}: ${period === 'both' ? 'AM+PM' : period.toUpperCase()} â†’ ${action.location}`;
        }
        default:
          return `âŒ Unknown action: ${action.type}`;
      }
    } catch (e) {
      return `âŒ Error executing action: ${e.message}`;
    }
  }

  async function sendChatMessage() {
    if (!chatInput.trim() || chatLoading) return;
    const userMsg = chatInput.trim();
    setChatInput('');
    setChatMessages(prev => [...prev, { role: 'user', content: userMsg }]);
    setChatLoading(true);

    const currentSchedule = getSchedule();
    const scheduleSummary = Object.keys(currentSchedule).length > 0
      ? `Current schedule for ${MONTHS[currentMonth]} ${currentYear} (Plan ${activePlan}) has ${Object.keys(currentSchedule).length} days filled.`
      : `No schedule generated yet for ${MONTHS[currentMonth]} ${currentYear} Plan ${activePlan}.`;

    const staffContext = staff.map(s => `${s.id}: ${s.name} (${s.role})`).join('\n');
    const locContext = locations.map(l => `${l.id}: ${l.name}`).join('\n');
    const vacContext = vacations.length > 0 ? vacations.map(v => {
      const s = staff.find(x => x.id === v.staffId);
      return `- ${s?.name||'?'}: ${v.startDate} to ${v.endDate} (${v.reason||'Vacation'}) [id:${v.id}]`;
    }).join('\n') : 'None';

    const systemPrompt = `You are an AI scheduling assistant for Schedule Helper. You can both ANSWER questions AND MAKE CHANGES to the schedule data.

Current context:
- Month: ${MONTHS[currentMonth]} ${currentYear}, Plan ${activePlan}
- ${scheduleSummary}

Staff:
${staffContext}

Locations:
${locContext}

Vacations:
${vacContext}

Holidays: ${holidays.map(h => { const dt = getHolidayDate(h, currentYear); return h.name + (h.halfDay === 'am' ? ' (AM only)' : '') + (dt ? ' ' + dateKey(dt.getFullYear(), dt.getMonth(), dt.getDate()) : ''); }).join(', ')}

Active rules: ${rules.length}
Rules summary:
${buildRulesSummary()}

ACTIONS: When the user asks you to make a change, include a JSON action block in your response using this exact format:

\`\`\`action
{"type": "action_type", ...params}
\`\`\`

Available actions:
- add_vacation: {"type":"add_vacation", "staffName":"Last Name", "startDate":"YYYY-MM-DD", "endDate":"YYYY-MM-DD", "reason":"optional"}
- remove_vacation: {"type":"remove_vacation", "staffName":"Last Name", "startDate":"YYYY-MM-DD"}
- add_staff: {"type":"add_staff", "name":"Full Name", "role":"MD|OD"}
- remove_staff: {"type":"remove_staff", "staffName":"Last Name"}
- add_location: {"type":"add_location", "name":"Location Name", "address":"optional"}
- remove_location: {"type":"remove_location", "name":"Location Name"}
- add_rule: {"type":"add_rule", "staffName":"Last Name", "locationName":"Location", "dayOfWeek":"Mon|Tue|Wed|Thu|Fri", "weekOfMonth":"all|1|2|3|4", "period":"am|pm|both", "priority":"required|preferred", "description":"optional"}
- remove_rule: {"type":"remove_rule", "staffName":"Last Name", "dayOfWeek":"Mon", "locationName":"Location"}
- add_holiday: {"type":"add_holiday", "name":"Holiday Name", "month":0, "day":1, "halfDay":"closed|am", "note":"optional"}  (month is 0-indexed: 0=Jan, 11=Dec)
- remove_holiday: {"type":"remove_holiday", "name":"Holiday Name"}
- update_schedule: {"type":"update_schedule", "staffName":"Last Name", "date":"YYYY-MM-DD", "location":"Location Name or OFF", "period":"am|pm|both"}

You can include MULTIPLE action blocks in one response. Always confirm what you're doing in natural language AND include the action block. If unsure about details, ask the user first.

For questions (not changes), just respond normally without action blocks. Be concise. Use last names for providers.`;

    try {
      const apiMessages = chatMessages.slice(-10).map(m => ({ role: m.role, content: m.content }));
      apiMessages.push({ role: 'user', content: userMsg });

      const response = await callClaudeAPI({
        model: "claude-sonnet-4-6",
        max_tokens: 1500,
        system: systemPrompt,
        messages: apiMessages
      });

      if (!response.ok) {
        setChatMessages(prev => [...prev, { role: 'assistant', content: `Error: API returned ${response.status}. Please try again.` }]);
        setChatLoading(false);
        return;
      }

      const data = await response.json();
      let text = (data.content || []).map(i => i.type === 'text' ? (i.text || '') : '').join('');

      // Extract and execute action blocks
      const actionRegex = /```action\s*\n?([\s\S]*?)```/g;
      let match;
      const results = [];
      while ((match = actionRegex.exec(text)) !== null) {
        try {
          const action = JSON.parse(match[1].trim());
          const result = executeAgentAction(action);
          results.push(result);
        } catch (e) {
          results.push(`âŒ Failed to parse action: ${e.message}`);
        }
      }

      // Remove action blocks from displayed text and append results
      let displayText = text.replace(/```action\s*\n?[\s\S]*?```/g, '').trim();
      if (results.length > 0) {
        displayText += '\n\n' + results.join('\n');
      }

      setChatMessages(prev => [...prev, { role: 'assistant', content: displayText || 'Done.' }]);
    } catch (err) {
      setChatMessages(prev => [...prev, { role: 'assistant', content: `Connection error: ${err.message}` }]);
    }
    setChatLoading(false);
  }

  // Shared: build unique staff initials with disambiguation (KMi vs KMc)
  function buildStaffInitials(staffList) {
    const suffixes = ['MD','OD','DO','NP','PA','RN','Jr','Sr','II','III'];
    function cleanParts(s) {
      return s.name.replace(/^Dr\.\s*/i,'').split(/\s+/).filter(p => !suffixes.includes(p.replace(/[.,]/g,'')));
    }
    // First pass: base initials
    const base = staffList.map(s => {
      const p = cleanParts(s);
      return p.length >= 2 ? (p[0][0] + p[p.length-1][0]).toUpperCase() : p[0].substring(0,2).toUpperCase();
    });
    // Find duplicates and disambiguate with lowercase 2nd letter of last name
    const counts = {};
    base.forEach(b => { counts[b] = (counts[b]||0)+1; });
    return staffList.map((s,i) => {
      if (counts[base[i]] > 1) {
        const p = cleanParts(s);
        const last = p.length >= 2 ? p[p.length-1] : p[0];
        return base[i] + last[1].toLowerCase();
      }
      return base[i];
    });
  }

  function generatePDF() {
    const planToUse = finalPlanForMonth || activePlan;
    const pdfScheduleKey = `schedule-${currentYear}-${currentMonth}-${planToUse}`;
    const schedule = schedules[pdfScheduleKey] || {};
    const calDays = getCalendarDays(currentYear, currentMonth);
    const filteredStaff = staff.filter(s => visibleStaff.has(s.id));
    const providerCount = filteredStaff.length;
    const initials = buildStaffInitials(filteredStaff);

    const locAbbrev = {};
    locations.forEach(l => { const n = l.name; locAbbrev[l.id] = n.length <= 10 ? n : n.split(/[\s\-\/]+/)[0]; });

    const rows = Math.ceil(calDays.length / 7);
    const scaleFactor = rows <= 4 ? 1.4 : rows <= 5 ? 1.15 : 0.95;
    const provScale = providerCount > 8 ? 0.88 : providerCount > 6 ? 0.95 : 1.0;
    const baseFont = 9.5 * scaleFactor * provScale;
    const nameFont = baseFont;
    const dayNumFont = baseFont * 1.4;
    const periodFont = baseFont * 0.8;
    const locFont = baseFont * 1.05;

    function buildCellHtml(day) {
      const dk = dateKey(currentYear, currentMonth, day);
      const ds = schedule[dk] || {};
      if (isWeekend(currentYear, currentMonth, day)) return '<td class="wk"><div class="dn">' + day + '</div></td>';
      const holiday = getHolidayForDate(currentYear, currentMonth, day);
      if (holiday && holiday.halfDay === 'closed') return '<td><div class="dn">' + day + '</div><div class="hol">' + holiday.name + '</div></td>';
      let c = '<td><div class="dn">' + day + '</div>';
      if (holiday && holiday.halfDay === 'am') c += '<div class="holam">AM Only â€” ' + holiday.name + '</div>';
      const allDay = [], splitAm = [], splitPm = [];
      filteredStaff.forEach((s,si) => {
        const p = ds[s.id]; if (!p) return;
        const am = p.am || 'OFF', pm = p.pm || 'OFF';
        if (am === 'OFF' && pm === 'OFF') { allDay.push({staff:s,locId:'OFF',init:initials[si]}); return; }
        if (am !== 'OFF' && pm !== 'OFF' && am === pm) allDay.push({staff:s,locId:am,init:initials[si]});
        else { if (am !== 'OFF') splitAm.push({staff:s,locId:am,init:initials[si]}); if (pm !== 'OFF') splitPm.push({staff:s,locId:pm,init:initials[si]}); }
      });
      function groupByLoc(entries) {
        const g = {}; entries.forEach(e => { if (!g[e.locId]) g[e.locId]={locId:e.locId,items:[]}; g[e.locId].items.push(e); });
        return Object.values(g).sort((a,b) => a.locId === 'OFF' ? 1 : b.locId === 'OFF' ? -1 : 0);
      }
      function renderGroup(g) {
        const isOff = g.locId === 'OFF';
        const tags = g.items.map(e => '<span class="tag" style="color:' + e.staff.color + '">' + e.init + '</span>').join(' ');
        if (isOff) return '<div class="grp off"><span class="tags">' + tags + '</span> <i>OFF</i></div>';
        return '<div class="grp"><span class="loc">' + (locAbbrev[g.locId]||'?') + '</span> <span class="tags">' + tags + '</span></div>';
      }
      groupByLoc(allDay).forEach(g => { c += renderGroup(g); });
      if (splitAm.length > 0 || splitPm.length > 0) {
        c += '<div class="split"><div class="sp"><div class="pl">AM</div>';
        groupByLoc(splitAm).forEach(g => { c += renderGroup(g); });
        c += '</div><div class="sp"><div class="pl">PM</div>';
        groupByLoc(splitPm).forEach(g => { c += renderGroup(g); });
        c += '</div></div>';
      }
      return c + '</td>';
    }

    let html = '<!DOCTYPE html><html><head><meta charset="utf-8"><title>' + MONTHS[currentMonth] + ' ' + currentYear + ' Schedule</title>';
    html += '<style>@import url("https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap");';
    html += '*{margin:0;padding:0;box-sizing:border-box}';
    html += '@page{size:landscape;margin:4mm 5mm}';
    html += 'body{font-family:"DM Sans",Arial,sans-serif;background:#fff;color:#222;-webkit-print-color-adjust:exact;print-color-adjust:exact}';
    html += '.hdr{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:2px}';
    html += 'h1{font-size:14px;font-weight:700}';
    html += '.sub{font-size:8px;color:#666}.plan{font-size:8px;color:#1a5;font-weight:700;background:#e6f9f0;padding:1px 5px;border-radius:3px}';
    html += '.legend{display:flex;flex-wrap:wrap;gap:3px 8px;margin-bottom:3px;padding:2px 6px;background:#f5f5f5;border-radius:3px;border:1px solid #e0e0e0}';
    html += '.li{display:flex;align-items:center;gap:3px;font-size:' + Math.max(9,baseFont*0.8) + 'px;font-weight:600}';
    html += '.ld{width:7px;height:7px;border-radius:50%;flex-shrink:0}';
    html += 'table{width:100%;border-collapse:collapse;table-layout:fixed}';
    html += 'th{background:#1a1a2e;color:#fff;padding:4px 2px;font-size:' + Math.max(10,baseFont) + 'px;font-weight:700;text-align:center}';
    html += 'td{border:1px solid #ccc;padding:3px 4px;vertical-align:top;font-size:' + nameFont + 'px;line-height:1.35;overflow:hidden}';
    html += '.dn{font-weight:700;font-size:' + dayNumFont + 'px;color:#1a1a2e;margin-bottom:2px}';
    html += '.wk{background:#f7f7f7}';
    html += '.grp{margin-bottom:2px;padding:2px 4px;border-radius:3px;background:#f8f8fb;border:1px solid #e5e5ea;white-space:normal;word-wrap:break-word}';
    html += '.grp.off{background:transparent;border:none;color:#aaa;font-style:italic}';
    html += '.loc{font-weight:700;color:#333;font-size:' + locFont + 'px}';
    html += '.tag{font-weight:600;font-size:' + nameFont + 'px}';
    html += '.tags{white-space:normal}';
    html += '.pl{font-weight:700;font-size:' + periodFont + 'px;text-transform:uppercase;color:#888;border-bottom:0.5px solid #ddd;margin:1px 0}';
    html += '.split{display:flex;gap:3px}.sp{flex:1;min-width:0}';
    html += '.hol{background:#fee2e2;color:#b91c1c;font-size:' + nameFont + 'px;font-weight:700;text-align:center;padding:4px;border-radius:3px;margin-top:2px}';
    html += '.holam{background:#fef3c7;color:#92400e;font-size:' + periodFont + 'px;font-weight:600;text-align:center;padding:1px;border-radius:2px;margin-bottom:2px}';
    html += '</style></head><body>';

    html += '<div class="hdr"><h1>' + MONTHS[currentMonth] + ' ' + currentYear + ' â€” Provider Schedule</h1><div>';
    html += '<span class="plan">Plan ' + planToUse + (finalPlanForMonth ? ' (Final)' : '') + '</span> ';
    html += '<span class="sub">Generated ' + new Date().toLocaleDateString() + '</span></div></div>';
    html += '<div class="legend">';
    filteredStaff.forEach((s,i) => { html += '<div class="li"><div class="ld" style="background:' + s.color + '"></div><b>' + initials[i] + '</b> = ' + getLastName(s.name) + '</div>'; });
    html += '</div><table><thead><tr>';
    DAYS_OF_WEEK.forEach(d => { html += '<th>' + d + '</th>'; });
    html += '</tr></thead><tbody><tr>';

    calDays.forEach((day, i) => {
      if (i > 0 && i % 7 === 0) html += '</tr><tr>';
      if (day === null) { html += '<td class="wk"></td>'; return; }
      html += buildCellHtml(day);
    });
    const rem = calDays.length % 7;
    if (rem > 0) for (let i = 0; i < 7 - rem; i++) html += '<td class="wk"></td>';
    html += '</tr></tbody></table></body></html>';

    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const w = window.open(url, '_blank');
    if (w) { w.onload = () => { setTimeout(() => { w.print(); }, 600); }; }
  }

  // Classic PDF: staff initials across top, location abbreviations in AM/PM rows with vertical text
  function generateClassicPDF() {
    const planToUse = finalPlanForMonth || activePlan;
    const pdfScheduleKey = `schedule-${currentYear}-${currentMonth}-${planToUse}`;
    const schedule = schedules[pdfScheduleKey] || {};
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const filteredStaff = staff.filter(s => visibleStaff.has(s.id));
    const staffCount = filteredStaff.length;
    const initials = buildStaffInitials(filteredStaff);

    // Location abbreviations: 1-5 chars
    const LA = {};
    const locLegend = [];
    locations.forEach(l => {
      const n = l.name.toLowerCase();
      let abbr = l.name.substring(0,4).toUpperCase();
      if (n.includes('manteca')) abbr = 'M';
      else if (n.includes('stockton')) abbr = 'S';
      else if (n.includes('modesto')) abbr = 'MOD';
      else if (n.includes('vlsc')) abbr = 'VLSC';
      else if (n.includes('msc') || n.includes('surgery center')) abbr = 'MSC';
      else if (n.includes('dhm') || n.includes('delta')) abbr = 'DHM';
      else if (n.includes('turlock')) abbr = 'T';
      else if (n.includes('admin')) abbr = 'ADM';
      else if (n.includes('lvc') || n.includes('lasik')) abbr = 'LVC';
      else if (n.includes('sjlsc') || n.includes('san joaquin')) abbr = 'SJ';
      else if (n.includes('ncsc') || n.includes('merced')) abbr = 'NC';
      else if (n.includes('va') || n.includes('veteran')) abbr = 'VA';
      LA[l.id] = abbr;
      locLegend.push({ abbr: abbr, name: l.name });
    });

    // Group weekdays by week
    const weekRows = [];
    let cw = [];
    for (let d = 1; d <= daysInMonth; d++) {
      const dow = new Date(currentYear, currentMonth, d).getDay();
      if (dow === 0 || dow === 6) continue;
      if (dow === 1 && cw.length > 0) { weekRows.push(cw); cw = []; }
      cw.push({ day: d, dow });
    }
    if (cw.length > 0) weekRows.push(cw);

    // Dynamic sizing
    const cellFs = staffCount > 8 ? 9 : staffCount > 6 ? 10 : 11;
    const initFs = staffCount > 8 ? 8 : staffCount > 6 ? 9 : 10;
    const dayNumFs = 12;
    const lblFs = Math.max(8, cellFs - 1);
    const amLblW = 20;
    const rowH = Math.floor(155 / weekRows.length);

    // For vertical text: split abbreviation into single chars stacked
    function vertLoc(abbr) {
      if (abbr.length <= 1) return abbr;
      return abbr.split('').join('<br>');
    }

    let html = '<!DOCTYPE html><html><head><meta charset="utf-8"><title>' + MONTHS[currentMonth] + ' ' + currentYear + ' Classic</title>';
    html += '<style>@import url("https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap");';
    html += '*{margin:0;padding:0;box-sizing:border-box}';
    html += '@page{size:landscape;margin:4mm 5mm}';
    html += 'body{font-family:"DM Sans",Arial,sans-serif;background:#fff;color:#000;-webkit-print-color-adjust:exact;print-color-adjust:exact}';
    html += '.hdr{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:2px}';
    html += 'h1{font-size:14px;font-weight:700}';
    html += '.meta{font-size:8px;color:#555}.plan{font-size:8px;color:#1a5;font-weight:700}';
    html += 'table{width:100%;border-collapse:collapse;table-layout:fixed}';
    html += 'th{background:#1a1a2e;color:#fff;padding:4px 2px;font-size:11px;font-weight:700;text-align:center;border:1px solid #666}';
    html += 'td{border:1px solid #888;padding:0;vertical-align:top}';
    html += '.daynum{font-weight:700;font-size:' + dayNumFs + 'px;padding:1px 4px;background:#eee;border-bottom:1px solid #bbb}';
    // Table layout for all inner rows
    html += '.row{display:table;width:100%;table-layout:fixed;height:' + Math.floor((rowH - 8) / 2) + 'mm}';
    html += '.row-spacer{display:table-cell;width:' + amLblW + 'px;background:#f0f0f5;border-right:0.5px solid #ccc}';
    html += '.irow{display:table;width:100%;table-layout:fixed;border-bottom:1px solid #bbb}';
    html += '.irow .row-spacer{background:#f0f0f5}';
    html += '.row-cell{display:table-cell;font-size:' + initFs + 'px;font-weight:700;text-align:center;color:#333;padding:2px 0;background:#f0f0f5;border-right:0.5px solid #ddd}';
    html += '.row-cell:last-child{border-right:none}';
    html += '.row-lbl{display:table-cell;width:' + amLblW + 'px;font-size:' + lblFs + 'px;font-weight:700;color:#555;text-align:center;vertical-align:middle;background:#f5f5f5;border-right:0.5px solid #ccc}';
    html += '.row-val{display:table-cell;font-size:' + cellFs + 'px;font-weight:600;text-align:center;border-right:0.5px solid #ddd;vertical-align:middle;line-height:1.1;padding:1px 0}';
    html += '.row-val:last-child{border-right:none}';
    html += '.row-val.off{color:#bbb;font-style:italic}';
    html += '.pm-border{border-top:1px solid #bbb}';
    html += '.hol{background:#fee2e2;color:#b91c1c;font-weight:700;font-size:' + cellFs + 'px;text-align:center;padding:8px 2px}';
    html += '.holam{background:#fef3c7;color:#92400e;font-size:' + (cellFs-1) + 'px;font-weight:600;text-align:center;padding:2px}';
    html += '.empty{background:#f9f9f9}';
    html += '.foot{margin-top:3px;padding:3px 6px;background:#f8f8f8;border:1px solid #ddd;border-radius:3px;font-size:8px;display:flex;flex-wrap:wrap;gap:4px 12px}';
    html += '.foot b{font-weight:700;margin-right:2px}';
    html += '</style></head><body>';

    html += '<div class="hdr"><h1>' + MONTHS[currentMonth].toUpperCase() + ' ' + currentYear + '</h1>';
    html += '<div><span class="plan">Plan ' + planToUse + (finalPlanForMonth ? ' (Final)' : '') + '</span> <span class="meta">Updated ' + new Date().toLocaleDateString() + '</span></div></div>';

    html += '<table><thead><tr>';
    ['Monday','Tuesday','Wednesday','Thursday','Friday'].forEach(dn => { html += '<th>' + dn + '</th>'; });
    html += '</tr></thead><tbody>';

    weekRows.forEach(week => {
      const ws = [null,null,null,null,null];
      week.forEach(d => { ws[d.dow - 1] = d; });
      html += '<tr>';
      ws.forEach(slot => {
        if (!slot) { html += '<td class="empty"></td>'; return; }
        const dk = dateKey(currentYear, currentMonth, slot.day);
        const hol = getHolidayForDate(currentYear, currentMonth, slot.day);
        html += '<td>';
        html += '<div class="daynum">' + slot.day + '</div>';
        if (hol && hol.halfDay === 'closed') { html += '<div class="hol">CLOSED â€” ' + hol.name + '</div></td>'; return; }

        // Initials row
        html += '<div class="irow"><div class="row-spacer"></div>';
        filteredStaff.forEach((s,i) => { html += '<div class="row-cell">' + initials[i] + '</div>'; });
        html += '</div>';

        if (hol && hol.halfDay === 'am') html += '<div class="holam">AM Only</div>';

        // AM row â€” location text vertical for multi-char
        html += '<div class="row"><div class="row-lbl">AM</div>';
        filteredStaff.forEach(s => {
          const a = schedule[dk] && schedule[dk][s.id] && schedule[dk][s.id].am;
          if (!a || a === 'OFF') html += '<div class="row-val off">OFF</div>';
          else html += '<div class="row-val">' + vertLoc(LA[a] || '?') + '</div>';
        });
        html += '</div>';

        // PM row
        html += '<div class="row pm-border"><div class="row-lbl">PM</div>';
        filteredStaff.forEach(s => {
          const a = (hol && hol.halfDay === 'am') ? null : (schedule[dk] && schedule[dk][s.id] && schedule[dk][s.id].pm);
          if (!a || a === 'OFF') html += '<div class="row-val off">OFF</div>';
          else html += '<div class="row-val">' + vertLoc(LA[a] || '?') + '</div>';
        });
        html += '</div>';
        html += '</td>';
      });
      html += '</tr>';
    });

    html += '</tbody></table>';

    // Legend at bottom
    html += '<div class="foot">';
    html += '<span><b>Staff:</b> ';
    html += filteredStaff.map((s,i) => initials[i] + '=' + getLastName(s.name)).join(', ');
    html += '</span>';
    html += '<span><b>Locations:</b> ';
    html += locLegend.map(ll => ll.abbr + '=' + ll.name).join(', ');
    html += '</span>';
    html += '</div>';

    html += '</body></html>';

    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const w = window.open(url, '_blank');
    if (w) { w.onload = () => { setTimeout(() => { w.print(); }, 600); }; }
  }

  const calDays = getCalendarDays(currentYear, currentMonth);
  const schedule = getSchedule();
  function prevMonth() { if (currentMonth===0){setCurrentMonth(11);setCurrentYear(y=>y-1)} else setCurrentMonth(m=>m-1); }
  function nextMonth() { if (currentMonth===11){setCurrentMonth(0);setCurrentYear(y=>y+1)} else setCurrentMonth(m=>m+1); }

  // Filtered rules for Rules tab
  const filteredRules = rulesFilter === 'all' ? rules : rules.filter(r => r.staffId === rulesFilter);

  if (loading) return (
    <div style={{minHeight:'100vh',background:'#0d0d1a',display:'flex',alignItems:'center',justifyContent:'center'}}>
      <div style={{color:'#6366f1',fontSize:18,fontFamily:'"DM Sans",sans-serif'}}>Loading...</div>
    </div>
  );

  // Login
  if (!user) return (
    <div style={{minHeight:'100vh',background:'linear-gradient(135deg,#0d0d1a 0%,#1a1035 50%,#0d0d1a 100%)',display:'flex',alignItems:'center',justifyContent:'center',fontFamily:'"DM Sans",sans-serif'}}>
      <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet" />
      <div style={{width:440,padding:48,background:'#1a1a2e',border:'1px solid #2a2a4a',borderRadius:20,boxShadow:'0 32px 80px rgba(0,0,0,0.6)'}}>
        <div style={{textAlign:'center',marginBottom:36}}>
          <div style={{fontSize:40,marginBottom:8}}>ðŸ“…</div>
          <h1 style={{fontSize:28,fontWeight:700,color:'#e8e8f0',margin:0,letterSpacing:'-0.02em'}}>Schedule Helper</h1>
          <p style={{color:'#6b7280',fontSize:14,marginTop:6}}>AI-Powered Staff Scheduling</p>
        </div>
        <Input label="Username" value={loginForm.username} onChange={v=>setLoginForm(p=>({...p,username:v}))} placeholder="Enter username" />
        <Input label="Password" value={loginForm.password} onChange={v=>setLoginForm(p=>({...p,password:v}))} placeholder="Enter password" type="password" />
        <Btn onClick={handleAuth} style={{width:'100%',padding:'14px',fontSize:15,marginTop:8}}>
          {loginForm.isRegister ? 'Create Account' : 'Sign In'}
        </Btn>
        <p style={{textAlign:'center',marginTop:16,fontSize:13,color:'#6b7280'}}>
          {loginForm.isRegister?'Already have an account?':"Don't have an account?"}{' '}
          <span onClick={()=>setLoginForm(p=>({...p,isRegister:!p.isRegister}))} style={{color:'#8b5cf6',cursor:'pointer',fontWeight:600}}>
            {loginForm.isRegister?'Sign In':'Register'}
          </span>
        </p>
        <div style={{marginTop:28,paddingTop:24,borderTop:'1px solid #2a2a4a',textAlign:'center'}}>
          <Btn variant="dev" onClick={handleDevLogin} style={{width:'100%',padding:'12px',fontSize:13,display:'flex',alignItems:'center',justifyContent:'center',gap:8}}>
            ðŸ”§ Developer Sign In
          </Btn>
          <p style={{fontSize:11,color:'#4b5563',marginTop:8}}>Pre-loaded with 10 providers, 12 locations & 78 scheduling rules</p>
        </div>
      </div>
    </div>
  );

  // Main App
  return (
    <div style={{minHeight:'100vh',background:'#0d0d1a',fontFamily:'"DM Sans",sans-serif',color:'#e8e8f0'}}>
      <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet" />

      {/* Top Bar */}
      <div style={{background:'#12121f',borderBottom:'1px solid #1e1e35',padding:'12px 28px',display:'flex',alignItems:'center',justifyContent:'space-between',position:'sticky',top:0,zIndex:100}}>
        <div style={{display:'flex',alignItems:'center',gap:12}}>
          <span style={{fontSize:24}}>ðŸ“…</span>
          <span style={{fontSize:20,fontWeight:700,letterSpacing:'-0.02em'}}>Schedule Helper</span>
          {isDev && <span style={{fontSize:10,fontWeight:700,padding:'3px 10px',borderRadius:20,background:'#92400e33',color:'#fbbf24',border:'1px solid #92400e',textTransform:'uppercase',letterSpacing:'0.08em'}}>Developer</span>}
        </div>
        <div style={{display:'flex',alignItems:'center',gap:12}}>
          {isDev && <Btn variant="ghost" onClick={resetDevData} style={{fontSize:11,padding:'5px 12px',color:'#f59e0b',borderColor:'#92400e'}}>ðŸ”„ Reset Presets</Btn>}
          <span style={{fontSize:13,color:'#6b7280'}}>ðŸ‘¤ {user.username}</span>
          <Btn variant="ghost" onClick={logout} style={{fontSize:12,padding:'6px 14px'}}>Logout</Btn>
        </div>
      </div>

      <div style={{display:'flex',minHeight:'calc(100vh - 53px)'}}>
        {/* Sidebar */}
        <div style={{width:220,background:'#12121f',borderRight:'1px solid #1e1e35',padding:'20px 0',flexShrink:0}}>
          {[
            {id:'schedule',icon:'ðŸ“…',label:'Schedule'},
            {id:'staff',icon:'ðŸ‘¥',label:`Staff (${staff.length})`},
            {id:'locations',icon:'ðŸ¢',label:`Locations (${locations.length})`},
            {id:'rules',icon:'âš™ï¸',label:`Rules (${rules.length})`},
            {id:'vacations',icon:'ðŸ–ï¸',label:`Vacation (${vacations.length})`},
            {id:'holidays',icon:'ðŸ“†',label:`Holidays (${holidays.length})`},
          ].map(tab => (
            <div key={tab.id} onClick={()=>setActiveTab(tab.id)}
              style={{padding:'12px 24px',cursor:'pointer',display:'flex',alignItems:'center',gap:10,fontSize:14,fontWeight:activeTab===tab.id?600:400,
                color:activeTab===tab.id?'#e8e8f0':'#6b7280',background:activeTab===tab.id?'#1e1e35':'transparent',
                borderRight:activeTab===tab.id?'2px solid #6366f1':'2px solid transparent',transition:'all 0.15s'}}>
              <span>{tab.icon}</span>{tab.label}
            </div>
          ))}
        </div>

        {/* Main Content */}
        <div style={{flex:1,padding:28,overflow:'auto'}}>

          {/* ===== SCHEDULE TAB ===== */}
          {activeTab === 'schedule' && (
            <div>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16,flexWrap:'wrap',gap:12}}>
                <div>
                  <h2 style={{fontSize:26,fontWeight:700,margin:0}}>Monthly Schedule</h2>
                  <p style={{color:'#6b7280',fontSize:13,marginTop:4}}>Click any weekday to assign providers â€¢ AM & PM shifts</p>
                </div>
                <div style={{display:'flex',gap:10,flexWrap:'wrap'}}>
                  <Btn variant="success" onClick={generateWithAI} disabled={generating}>
                    {generating ? 'â³ Generating...' : 'âœ¨ Generate with AI'}
                  </Btn>
                  <div data-pdf-menu="true" style={{position:'relative'}}>
                    <Btn variant="secondary" onClick={()=>setShowPdfMenu(p=>!p)}>ðŸ“„ Export PDF â–¾</Btn>
                    {showPdfMenu && (
                      <div style={{position:'absolute',top:'100%',right:0,marginTop:4,background:'#1e1e35',border:'1px solid #2a2a4a',borderRadius:8,boxShadow:'0 8px 24px rgba(0,0,0,0.5)',zIndex:100,overflow:'hidden',minWidth:200}}>
                        <div onClick={()=>{generateClassicPDF();setShowPdfMenu(false)}}
                          style={{padding:'10px 16px',cursor:'pointer',fontSize:13,fontWeight:600,color:'#e8e8f0',borderBottom:'1px solid #2a2a4a',display:'flex',alignItems:'center',gap:8}}
                          onMouseEnter={e=>e.target.style.background='#2a2a4a'} onMouseLeave={e=>e.target.style.background='transparent'}>
                          <span>ðŸ“Š</span><div><div>Classic Style</div><div style={{fontSize:10,color:'#6b7280',fontWeight:400}}>Initials grid â€” matches original PDF</div></div>
                        </div>
                        <div onClick={()=>{generatePDF();setShowPdfMenu(false)}}
                          style={{padding:'10px 16px',cursor:'pointer',fontSize:13,fontWeight:600,color:'#e8e8f0',display:'flex',alignItems:'center',gap:8}}
                          onMouseEnter={e=>e.target.style.background='#2a2a4a'} onMouseLeave={e=>e.target.style.background='transparent'}>
                          <span>ðŸ“‹</span><div><div>New Style</div><div style={{fontSize:10,color:'#6b7280',fontWeight:400}}>Location-grouped blocks â€” full names</div></div>
                        </div>
                      </div>
                    )}
                  </div>
                  <Btn variant="danger" onClick={clearSchedule} style={{fontSize:12}}>Clear</Btn>
                </div>
              </div>

              {/* Staff Filter */}
              <div style={{padding:'12px 16px',background:'#1a1a2e',borderRadius:10,border:'1px solid #1e1e35',marginBottom:16}}>
                <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:10}}>
                  <span style={{fontSize:11,color:'#4b5563',fontWeight:700,textTransform:'uppercase',letterSpacing:'0.06em'}}>Filter Providers:</span>
                  <span onClick={showAllStaff}
                    style={{fontSize:11,color:visibleStaff.size===staff.length?'#818cf8':'#6b7280',cursor:'pointer',fontWeight:600,padding:'2px 10px',borderRadius:12,background:visibleStaff.size===staff.length?'#6366f122':'transparent',border:`1px solid ${visibleStaff.size===staff.length?'#6366f144':'#2a2a4a'}`,transition:'all 0.15s'}}>
                    Show All
                  </span>
                  <span onClick={showNoneStaff}
                    style={{fontSize:11,color:visibleStaff.size===0?'#818cf8':'#6b7280',cursor:'pointer',fontWeight:600,padding:'2px 10px',borderRadius:12,background:visibleStaff.size===0?'#6366f122':'transparent',border:`1px solid ${visibleStaff.size===0?'#6366f144':'#2a2a4a'}`,transition:'all 0.15s'}}>
                    Clear All
                  </span>
                </div>
                <div style={{display:'flex',flexWrap:'wrap',gap:6}}>
                  {staff.map(s => {
                    const active = visibleStaff.has(s.id);
                    return (
                      <div key={s.id} onClick={() => toggleStaffVisibility(s.id)}
                        style={{display:'flex',alignItems:'center',gap:6,padding:'5px 12px',borderRadius:20,cursor:'pointer',fontSize:12,fontWeight:600,userSelect:'none',
                          background:active?s.color+'20':'#12121f',color:active?s.color:'#4b5563',border:`1px solid ${active?s.color+'55':'#2a2a4a'}`,transition:'all 0.15s'}}>
                        <div style={{width:14,height:14,borderRadius:4,border:`2px solid ${active?s.color:'#4b5563'}`,background:active?s.color:'transparent',display:'flex',alignItems:'center',justifyContent:'center',fontSize:9,color:'#fff',lineHeight:1,transition:'all 0.15s'}}>
                          {active && 'âœ“'}
                        </div>
                        {getLastName(s.name)}
                        <span style={{fontSize:10,opacity:0.6}}>{s.role === 'Ophthalmologist' ? 'MD' : 'OD'}</span>
                      </div>
                    );
                  })}
                </div>
              </div>

              {/* Location Filter */}
              <div style={{padding:'12px 16px',background:'#1a1a2e',borderRadius:10,border:'1px solid #1e1e35',marginBottom:16}}>
                <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:10}}>
                  <span style={{fontSize:11,color:'#4b5563',fontWeight:700,textTransform:'uppercase',letterSpacing:'0.06em'}}>Filter Locations:</span>
                  <span onClick={showAllLocations}
                    style={{fontSize:11,color:visibleLocations.size===locations.length?'#818cf8':'#6b7280',cursor:'pointer',fontWeight:600,padding:'2px 10px',borderRadius:12,background:visibleLocations.size===locations.length?'#6366f122':'transparent',border:`1px solid ${visibleLocations.size===locations.length?'#6366f144':'#2a2a4a'}`,transition:'all 0.15s'}}>
                    Show All
                  </span>
                  <span onClick={showNoneLocations}
                    style={{fontSize:11,color:visibleLocations.size===0?'#818cf8':'#6b7280',cursor:'pointer',fontWeight:600,padding:'2px 10px',borderRadius:12,background:visibleLocations.size===0?'#6366f122':'transparent',border:`1px solid ${visibleLocations.size===0?'#6366f144':'#2a2a4a'}`,transition:'all 0.15s'}}>
                    Clear All
                  </span>
                </div>
                <div style={{display:'flex',flexWrap:'wrap',gap:6}}>
                  {locations.slice().sort((a,b)=>a.name.localeCompare(b.name)).map(l => {
                    const active = visibleLocations.has(l.id);
                    const lc = LOCATION_COLORS[l.id] || LOCATION_COLORS.OFF;
                    return (
                      <div key={l.id} onClick={() => toggleLocationVisibility(l.id)}
                        style={{display:'flex',alignItems:'center',gap:6,padding:'5px 12px',borderRadius:20,cursor:'pointer',fontSize:12,fontWeight:600,userSelect:'none',
                          background:active?lc.bg:'#12121f',color:active?lc.text:'#4b5563',border:`1px solid ${active?lc.border:'#2a2a4a'}`,transition:'all 0.15s'}}>
                        <div style={{width:14,height:14,borderRadius:4,border:`2px solid ${active?lc.border:'#4b5563'}`,background:active?lc.border:'transparent',display:'flex',alignItems:'center',justifyContent:'center',fontSize:9,color:'#fff',lineHeight:1,transition:'all 0.15s'}}>
                          {active && 'âœ“'}
                        </div>
                        {l.name}
                      </div>
                    );
                  })}
                </div>
              </div>

              {/* AI Agent Chat */}
              <div style={{marginBottom:16,border:'1px solid #2a2a4a',borderRadius:12,overflow:'hidden',background:'#1a1a2e'}}>
                <div onClick={()=>setShowChat(p=>!p)}
                  style={{padding:'10px 16px',display:'flex',justifyContent:'space-between',alignItems:'center',cursor:'pointer',background:'linear-gradient(135deg,#1a1035,#1a1a2e)'}}>
                  <span style={{fontSize:13,fontWeight:700,color:'#a78bfa',display:'flex',alignItems:'center',gap:8}}>
                    ðŸ¤– AI Scheduling Agent
                    <span style={{fontSize:10,color:'#6b7280',fontWeight:400}}>Ask questions, request changes, get analysis</span>
                  </span>
                  <span style={{color:'#6b7280',fontSize:12}}>{showChat ? 'â–¼' : 'â–¶'}</span>
                </div>
                {showChat && (
                  <div>
                    <div style={{height:250,overflow:'auto',padding:12,background:'#12121f',borderTop:'1px solid #2a2a4a'}}>
                      {chatMessages.length === 0 && (
                        <div style={{textAlign:'center',padding:20,color:'#4b5563'}}>
                          <div style={{fontSize:28,marginBottom:8}}>ðŸ¤–</div>
                          <p style={{fontSize:12,marginBottom:4}}>Ask me anything about the schedule.</p>
                          <p style={{fontSize:11,color:'#374151'}}>Examples: "Who covers Manteca on Mondays?" â€¢ "Add a vacation for Dr. Kim next week" â€¢ "Are there any coverage gaps?"</p>
                        </div>
                      )}
                      {chatMessages.map((msg, i) => (
                        <div key={i} style={{display:'flex',justifyContent:msg.role==='user'?'flex-end':'flex-start',marginBottom:8}}>
                          <div style={{maxWidth:'80%',padding:'8px 14px',borderRadius:12,fontSize:13,lineHeight:1.5,whiteSpace:'pre-wrap',
                            background:msg.role==='user'?'#6366f133':'#1a1a2e',
                            color:msg.role==='user'?'#c7d2fe':'#d1d5db',
                            border:`1px solid ${msg.role==='user'?'#6366f144':'#2a2a4a'}`,
                            borderBottomRightRadius:msg.role==='user'?4:12,
                            borderBottomLeftRadius:msg.role==='user'?12:4}}>
                            {msg.content}
                          </div>
                        </div>
                      ))}
                      {chatLoading && (
                        <div style={{display:'flex',justifyContent:'flex-start',marginBottom:8}}>
                          <div style={{padding:'8px 14px',borderRadius:12,background:'#1a1a2e',border:'1px solid #2a2a4a',color:'#6b7280',fontSize:13}}>
                            <span style={{animation:'spin 1s linear infinite',display:'inline-block'}}>â³</span> Thinking...
                          </div>
                        </div>
                      )}
                      <div ref={chatEndRef} />
                    </div>
                    <div style={{display:'flex',gap:8,padding:10,borderTop:'1px solid #2a2a4a',background:'#1a1a2e'}}>
                      <input value={chatInput} onChange={e=>setChatInput(e.target.value)}
                        onKeyDown={e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendChatMessage()}}}
                        placeholder="Ask about the schedule, request changes..."
                        style={{flex:1,padding:'10px 14px',background:'#12121f',border:'1px solid #2a2a4a',borderRadius:8,color:'#e8e8f0',fontSize:13,fontFamily:'"DM Sans",sans-serif',outline:'none'}} />
                      <Btn onClick={sendChatMessage} disabled={chatLoading||!chatInput.trim()} style={{padding:'10px 18px'}}>
                        {chatLoading ? '...' : 'Send'}
                      </Btn>
                    </div>
                  </div>
                )}
              </div>

              {aiLog && (
                <div style={{padding:'12px 18px',background:generating?'#1e1b4b':(conflictsReport&&conflictsReport.conflicts&&conflictsReport.conflicts.length?'#78350f':'#064e3b'),border:`1px solid ${generating?'#3730a3':(conflictsReport&&conflictsReport.conflicts&&conflictsReport.conflicts.length?'#92400e':'#065f46')}`,borderRadius:10,marginBottom:conflictsReport&&conflictsReport.conflicts&&conflictsReport.conflicts.length?8:16,fontSize:13,color:generating?'#a5b4fc':(conflictsReport&&conflictsReport.conflicts&&conflictsReport.conflicts.length?'#fbbf24':'#6ee7b7'),display:'flex',alignItems:'center',gap:10}}>
                  {generating && <span style={{animation:'spin 1s linear infinite',display:'inline-block'}}>â³</span>}
                  <span style={{flex:1}}>{aiLog}</span>
                  {!generating && <span onClick={()=>{setAiLog('');setConflictsReport(null)}} style={{cursor:'pointer',opacity:0.6}}>âœ•</span>}
                </div>
              )}

              {/* Conflicts Report */}
              {conflictsReport && conflictsReport.conflicts.length > 0 && !generating && (
                <div style={{background:'#1a1520',border:'1px solid #92400e',borderRadius:10,marginBottom:16,overflow:'hidden'}}>
                  <div style={{padding:'10px 16px',background:'#78350f33',display:'flex',alignItems:'center',justifyContent:'space-between'}}>
                    <span style={{fontSize:13,fontWeight:700,color:'#fbbf24'}}>âš ï¸ {conflictsReport.conflicts.length} Rule Conflict{conflictsReport.conflicts.length>1?'s':''} Detected</span>
                    <div style={{display:'flex',gap:8}}>
                      <Btn variant="success" onClick={()=>{
                        conflictsReport.conflicts.forEach(c => { if (c.fix) applyConflictFix(c.fix); });
                        setConflictsReport(null); setAiLog('âœ… All conflicts resolved â€” rules applied.');
                      }} style={{fontSize:11,padding:'4px 12px'}}>Fix All</Btn>
                      <Btn variant="ghost" onClick={()=>setConflictsReport(null)} style={{fontSize:11,padding:'4px 10px'}}>Dismiss</Btn>
                    </div>
                  </div>
                  <div style={{maxHeight:250,overflowY:'auto',padding:'8px 12px'}}>
                    {conflictsReport.conflicts.map((c, ci) => (
                      <div key={ci} style={{display:'flex',alignItems:'center',gap:8,padding:'8px 10px',background:ci%2===0?'#1e1530':'transparent',borderRadius:6,marginBottom:2}}>
                        <div style={{flex:1,minWidth:0}}>
                          <div style={{fontSize:12,fontWeight:600,color:'#fbbf24'}}>{c.message}</div>
                          <div style={{fontSize:11,color:'#9ca3af',marginTop:2}}>
                            {c.date} ({c.day}) â€” Current: {c.current} â†’ Suggested: {c.suggested}
                          </div>
                        </div>
                        {c.fix && (
                          <Btn variant="success" onClick={()=>{
                            applyConflictFix(c.fix);
                            setConflictsReport(prev => {
                              if (!prev) return null;
                              const remaining = prev.conflicts.filter((_, j) => j !== ci);
                              if (remaining.length === 0) { setAiLog('âœ… All conflicts resolved!'); return null; }
                              return { ...prev, conflicts: remaining };
                            });
                          }} style={{fontSize:10,padding:'3px 10px',whiteSpace:'nowrap'}}>Fix</Btn>
                        )}
                        <Btn variant="ghost" onClick={()=>{
                          setConflictsReport(prev => {
                            if (!prev) return null;
                            const remaining = prev.conflicts.filter((_, j) => j !== ci);
                            if (remaining.length === 0) return null;
                            return { ...prev, conflicts: remaining };
                          });
                        }} style={{fontSize:10,padding:'3px 8px',color:'#6b7280'}}>Skip</Btn>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              <div style={{display:'flex',alignItems:'center',gap:16,marginBottom:12}}>
                <Btn variant="ghost" onClick={()=>{
                  if (calendarView === 'week' && currentWeekStart) {
                    const prev = new Date(currentWeekStart); prev.setDate(prev.getDate() - 7);
                    setCurrentWeekStart(prev);
                    if (prev.getMonth() !== currentMonth) { setCurrentMonth(prev.getMonth()); setCurrentYear(prev.getFullYear()); }
                  } else { prevMonth(); }
                }} style={{padding:'8px 14px'}}>â—€</Btn>
                <h3 style={{fontSize:20,fontWeight:600,minWidth:220,textAlign:'center',fontFamily:'"Space Mono",monospace'}}>
                  {calendarView === 'week' && currentWeekStart
                    ? `${MONTHS[currentWeekStart.getMonth()]} ${currentWeekStart.getDate()}â€“${(()=>{const e=new Date(currentWeekStart);e.setDate(e.getDate()+4);return e.getDate()})()}, ${currentWeekStart.getFullYear()}`
                    : `${MONTHS[currentMonth]} ${currentYear}`}
                </h3>
                <Btn variant="ghost" onClick={()=>{
                  if (calendarView === 'week' && currentWeekStart) {
                    const nxt = new Date(currentWeekStart); nxt.setDate(nxt.getDate() + 7);
                    setCurrentWeekStart(nxt);
                    if (nxt.getMonth() !== currentMonth) { setCurrentMonth(nxt.getMonth()); setCurrentYear(nxt.getFullYear()); }
                  } else { nextMonth(); }
                }} style={{padding:'8px 14px'}}>â–¶</Btn>
                <Btn variant="ghost" onClick={()=>{
                  const today = new Date();
                  setCurrentMonth(today.getMonth()); setCurrentYear(today.getFullYear());
                  const d = today.getDay(); const diff = d === 0 ? -6 : 1 - d;
                  const mon = new Date(today); mon.setDate(today.getDate() + diff);
                  setCurrentWeekStart(mon);
                }} style={{padding:'8px 14px',fontSize:11}}>Today</Btn>
                <Btn variant="ghost" onClick={undoSchedule} disabled={!canUndo}
                  style={{padding:'8px 12px',fontSize:13,opacity:canUndo?1:0.35,cursor:canUndo?'pointer':'default'}}
                  title="Undo last schedule change">â†©</Btn>
                <Btn variant="ghost" onClick={redoSchedule} disabled={!canRedo}
                  style={{padding:'8px 12px',fontSize:13,opacity:canRedo?1:0.35,cursor:canRedo?'pointer':'default'}}
                  title="Redo last undone change">â†ª</Btn>
                <div style={{marginLeft:'auto',display:'flex',gap:2,background:'#1a1a2e',borderRadius:8,padding:2,border:'1px solid #1e1e35'}}>
                  {[{v:'month',label:'Month'},{v:'week',label:'Week'}].map(({v,label})=>(
                    <div key={v} onClick={()=>{
                      setCalendarView(v);
                      if (v === 'week' && !currentWeekStart) {
                        const d1 = new Date(currentYear, currentMonth, 1);
                        const dow = d1.getDay(); const diff = dow === 0 ? -6 : 1 - dow;
                        const mon = new Date(d1); mon.setDate(d1.getDate() + diff);
                        setCurrentWeekStart(mon);
                      }
                    }}
                      style={{padding:'6px 16px',borderRadius:6,cursor:'pointer',fontSize:12,fontWeight:600,
                        background:calendarView===v?'#6366f1':'transparent',color:calendarView===v?'#fff':'#6b7280',
                        transition:'all 0.15s'}}>{label}</div>
                  ))}
                </div>
              </div>

              {/* Plan Selector */}
              <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:16,padding:'12px 16px',background:'#1a1a2e',borderRadius:10,border:'1px solid #1e1e35'}}>
                <span style={{fontSize:11,color:'#4b5563',fontWeight:700,textTransform:'uppercase',letterSpacing:'0.06em'}}>Plans:</span>
                {['A','B','C'].map(plan => {
                  const hasData = planHasData(plan);
                  const isFinal = finalPlanForMonth === plan;
                  const isActive = activePlan === plan;
                  return (
                    <div key={plan} onClick={()=>setActivePlan(plan)}
                      style={{display:'flex',alignItems:'center',gap:6,padding:'8px 18px',borderRadius:8,cursor:'pointer',fontSize:13,fontWeight:700,userSelect:'none',transition:'all 0.15s',
                        background:isActive?(isFinal?'#065f4622':'#6366f122'):'#12121f',
                        color:isActive?(isFinal?'#34d399':'#818cf8'):(hasData?'#9ca3af':'#4b5563'),
                        border:`1px solid ${isActive?(isFinal?'#065f46':'#6366f1'):(hasData?'#2a2a4a':'#1e1e35')}`}}>
                      Plan {plan}
                      {hasData && <span style={{width:6,height:6,borderRadius:'50%',background:isFinal?'#10b981':'#6366f1'}} />}
                      {isFinal && <span style={{fontSize:9,color:'#10b981',fontWeight:800,textTransform:'uppercase'}}>Final</span>}
                    </div>
                  );
                })}
                <div style={{marginLeft:8,display:'flex',gap:6}}>
                  {finalPlanForMonth !== activePlan ? (
                    <Btn variant="success" onClick={()=>setFinalPlan(activePlan)} style={{fontSize:11,padding:'5px 12px'}} disabled={!planHasData(activePlan)}>
                      âœ“ Set as Final
                    </Btn>
                  ) : (
                    <Btn variant="ghost" onClick={clearFinalPlan} style={{fontSize:11,padding:'5px 12px',color:'#f59e0b',borderColor:'#92400e'}}>
                      Unset Final
                    </Btn>
                  )}
                  {planHasData(activePlan) && (
                    <div style={{position:'relative'}}>
                      <select onChange={e=>{if(e.target.value)copyPlanTo(activePlan,e.target.value);e.target.value=''}}
                        style={{padding:'5px 10px',background:'#12121f',border:'1px solid #2a2a4a',borderRadius:6,color:'#9ca3af',fontSize:11,fontFamily:'"DM Sans",sans-serif',cursor:'pointer'}}>
                        <option value="">Copy to...</option>
                        {['A','B','C'].filter(p=>p!==activePlan).map(p=>(
                          <option key={p} value={p}>Plan {p}{planHasData(p)?' (overwrite)':''}</option>
                        ))}
                      </select>
                    </div>
                  )}
                </div>
              </div>

              <div style={{borderRadius:14,overflow:'hidden',border:'1px solid #1e1e35',background:'#12121f'}}>
                {/* Day headers */}
                <div style={{display:'grid',gridTemplateColumns:calendarView==='week'?'repeat(5,1fr)':'repeat(7,1fr)'}}>
                  {(calendarView==='week'?DAYS_OF_WEEK.slice(1,6):DAYS_OF_WEEK).map(d=>(
                    <div key={d} style={{padding:'10px 8px',textAlign:'center',fontSize:12,fontWeight:700,color:'#9ca3af',background:'#1a1a2e',borderBottom:'1px solid #1e1e35',textTransform:'uppercase',letterSpacing:'0.08em'}}>{d}</div>
                  ))}
                </div>

                {/* Calendar cells */}
                {(()=>{
                  // Build array of days to show
                  let daysToRender = [];
                  if (calendarView === 'week' && currentWeekStart) {
                    for (let i = 0; i < 5; i++) {
                      const d = new Date(currentWeekStart);
                      d.setDate(d.getDate() + i);
                      daysToRender.push({ day: d.getDate(), month: d.getMonth(), year: d.getFullYear(), isCurrentMonth: d.getMonth() === currentMonth });
                    }
                  } else {
                    daysToRender = calDays.map(day => day === null ? null : { day, month: currentMonth, year: currentYear, isCurrentMonth: true });
                  }

                  const isWeekView = calendarView === 'week';
                  const cols = isWeekView ? 5 : 7;

                  return (
                    <div style={{display:'grid',gridTemplateColumns:`repeat(${cols},1fr)`}}>
                      {daysToRender.map((cell,i)=>{
                        if(cell===null) return <div key={`e-${i}`} style={{minHeight:isWeekView?200:100,background:'#0d0d18',borderRight:'1px solid #1e1e35',borderBottom:'1px solid #1e1e35'}} />;

                        const {day, month: cellMonth, year: cellYear, isCurrentMonth: isCurMonth} = cell;
                        const dk=dateKey(cellYear,cellMonth,day);
                        const wkend=isWeekend(cellYear,cellMonth,day);
                        const schedule = getSchedule();
                        const ds=schedule[dk]||{};
                        const filteredStaffList = staff.filter(s => visibleStaff.has(s.id));
                        const cellMinH = isWeekView ? 200 : 100;

                        // Hybrid display logic
                        function getHybridDisplay() {
                          const allDay = [];
                          const splitAm = [];
                          const splitPm = [];
                          filteredStaffList.forEach(s => {
                            const am = ds[s.id]?.am;
                            const pm = ds[s.id]?.pm;
                            if (!am && !pm) return;
                            const amOk = am && (am === 'OFF' || visibleLocations.has(am));
                            const pmOk = pm && (pm === 'OFF' || visibleLocations.has(pm));
                            if (amOk && pmOk && am === pm) { allDay.push({ staff: s, locId: am }); }
                            else { if (amOk) splitAm.push({ staff: s, locId: am }); if (pmOk) splitPm.push({ staff: s, locId: pm }); }
                          });
                          function groupByLoc(entries) {
                            const groups = {};
                            entries.forEach(e => { const key = e.locId === 'OFF' ? 'OFF' : e.locId; if (!groups[key]) groups[key] = { locId: e.locId, staff: [] }; groups[key].staff.push(e.staff); });
                            return Object.values(groups).sort((a, b) => { if (a.locId === 'OFF') return 1; if (b.locId === 'OFF') return -1; const nA = (locations.find(l => l.id === a.locId)?.name || '').toLowerCase(); const nB = (locations.find(l => l.id === b.locId)?.name || '').toLowerCase(); return nA.localeCompare(nB); });
                          }
                          return { allDayGroups: groupByLoc(allDay), amGroups: groupByLoc(splitAm), pmGroups: groupByLoc(splitPm), hasSplit: splitAm.length > 0 || splitPm.length > 0 };
                        }

                        const hybrid = getHybridDisplay();
                        const isWk = isWeekView;
                        const fs = isWk ? {loc:12,name:13,dot:7,dayNum:18,wk:10,hol:11,holSub:10,ampm:10} : {loc:10,name:11,dot:6,dayNum:14,wk:9,hol:9,holSub:8,ampm:9};

                        function renderLocBlock(g, gi) {
                          const isOff = g.locId === 'OFF';
                          const loc = isOff ? null : locations.find(function(l){return l.id===g.locId});
                          const lc = LOCATION_COLORS[g.locId] || LOCATION_COLORS.OFF;
                          const locName = loc ? loc.name : '?';
                          // Multi-column: location name left, staff names flow right
                          return (
                            <div key={gi} style={{background:lc.bg,borderLeft:'3px solid '+lc.border,borderRadius:4,padding:isWk?'3px 5px':'2px 4px',marginBottom:isWk?3:2,display:'flex',alignItems:'flex-start',gap:isWk?6:4,flexWrap:'wrap'}}>
                              {!isOff && <div style={{fontSize:fs.loc,fontWeight:700,color:lc.text,lineHeight:1.3,whiteSpace:'nowrap',minWidth:isWk?'auto':0,flexShrink:isWk?0:1,overflow:'hidden',textOverflow:'ellipsis'}}>{locName}</div>}
                              <div style={{display:'flex',flexWrap:'wrap',gap:isWk?'2px 8px':'1px 6px',flex:1,minWidth:0}}>
                                {g.staff.map(function(s){return(
                                  <div key={s.id} style={{display:'flex',alignItems:'center',gap:2}}>
                                    <div style={{width:fs.dot,height:fs.dot,borderRadius:'50%',background:isOff?'#444':s.color,flexShrink:0}} />
                                    <span style={{fontSize:fs.name,color:isOff?'#556':s.color,fontWeight:600,whiteSpace:'nowrap'}}>
                                      {getLastName(s.name)}
                                    </span>
                                  </div>
                                )})}
                              </div>
                            </div>
                          );
                        }

                        return (
                          <div key={cellYear+'-'+cellMonth+'-'+day}
                            style={{minHeight:cellMinH,padding:isWk?'6px 6px':'4px 4px',borderRight:'1px solid #1e1e35',borderBottom:'1px solid #1e1e35',background:wkend?'#0d0d18':(isCurMonth?'#12121f':'#0e0e1a'),cursor:wkend?'default':'pointer',transition:'background 0.15s',overflow:'hidden',opacity:isCurMonth?1:0.5}}
                            onClick={function(){if(!wkend)setEditCell({day:day,dk:dk})}}
                            onMouseEnter={function(e){if(!wkend)e.currentTarget.style.background='#1a1a30'}}
                            onMouseLeave={function(e){if(!wkend)e.currentTarget.style.background=wkend?'#0d0d18':'#12121f'}}>
                            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:isWk?4:2,padding:'0 2px'}}>
                              <span style={{fontSize:fs.dayNum,fontWeight:700,color:wkend?'#374151':'#e8e8f0'}}>{day}</span>
                              {!wkend&&<span style={{fontSize:fs.wk,color:'#4b5563',fontWeight:600}}>W{getWeekOfMonth(day)}</span>}
                            </div>
                            {(function(){
                              var holiday = getHolidayForDate(cellYear, cellMonth, day);
                              if (holiday && holiday.halfDay === 'am') return (
                                <div style={{background:'#78350f33',border:'1px solid #f59e0b44',borderRadius:4,padding:'3px 5px',textAlign:'center',margin:'2px 0',marginBottom:3}}>
                                  <div style={{fontSize:fs.hol,fontWeight:700,color:'#f59e0b'}}>{'âš ï¸ '+holiday.name+' â€” AM Only'}</div>
                                </div>
                              );
                              if (holiday) return (
                                <div style={{background:'#7f1d1d44',border:'1px solid #ef444466',borderRadius:4,padding:'4px 5px',textAlign:'center',margin:'2px 0'}}>
                                  <div style={{fontSize:fs.hol,fontWeight:800,color:'#ef4444',textTransform:'uppercase',letterSpacing:'0.05em'}}>Holiday</div>
                                  <div style={{fontSize:fs.holSub,color:'#fca5a5',fontWeight:600,marginTop:1}}>{holiday.name}</div>
                                </div>
                              );
                              return null;
                            })()}
                            {!wkend && (
                              <div>
                                {hybrid.allDayGroups.map(function(g, gi){return renderLocBlock(g, 'u-'+gi)})}
                                {hybrid.hasSplit && (
                                  <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:isWk?4:2}}>
                                    {[{period:'am',groups:hybrid.amGroups},{period:'pm',groups:hybrid.pmGroups}].map(function(item){return(
                                      <div key={item.period} style={{minHeight:0}}>
                                        <div style={{fontSize:fs.ampm,fontWeight:800,color:'#555',textTransform:'uppercase',letterSpacing:'0.1em',textAlign:'center',marginBottom:1,borderBottom:'1px solid #1e1e35',paddingBottom:1}}>{item.period}</div>
                                        {item.groups.map(function(g, gi){return renderLocBlock(g, item.period+'-'+gi)})}
                                      </div>
                                    )})}
                                  </div>
                                )}
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  );
                })()}
              </div>

              <div style={{display:'flex',flexWrap:'wrap',gap:12,marginTop:16,padding:'12px 16px',background:'#1a1a2e',borderRadius:10,border:'1px solid #1e1e35'}}>
                <span style={{fontSize:11,color:'#4b5563',fontWeight:700,textTransform:'uppercase',letterSpacing:'0.06em',alignSelf:'center'}}>Providers:</span>
                {staff.map(s=>(
                  <div key={s.id} style={{display:'flex',alignItems:'center',gap:5,fontSize:11}}>
                    <div style={{width:9,height:9,borderRadius:'50%',background:s.color,flexShrink:0}} />
                    <span style={{color:'#9ca3af'}}>{s.name}</span>
                  </div>
                ))}
              </div>
              <div style={{display:'flex',flexWrap:'wrap',gap:8,marginTop:8,padding:'10px 16px',background:'#1a1a2e',borderRadius:10,border:'1px solid #1e1e35'}}>
                <span style={{fontSize:11,color:'#4b5563',fontWeight:700,textTransform:'uppercase',letterSpacing:'0.06em',alignSelf:'center'}}>Locations:</span>
                {locations.slice().sort((a,b)=>a.name.localeCompare(b.name)).map(l=>{
                  const lc = LOCATION_COLORS[l.id] || LOCATION_COLORS.OFF;
                  return (
                    <div key={l.id} style={{display:'flex',alignItems:'center',gap:5,fontSize:11,padding:'3px 10px',borderRadius:6,background:lc.bg,borderLeft:`3px solid ${lc.border}`}}>
                      <span style={{color:lc.text,fontWeight:600}}>{l.name}</span>
                    </div>
                  );
                })}
              </div>

              {/* Developer Log Panel */}
              {isDev && (
                <div style={{marginTop:20,border:'1px solid #92400e44',borderRadius:12,overflow:'hidden'}}>
                  <div onClick={()=>setShowLogs(p=>!p)}
                    style={{padding:'10px 16px',background:'#1a1a2e',display:'flex',justifyContent:'space-between',alignItems:'center',cursor:'pointer',borderBottom:showLogs?'1px solid #92400e44':'none'}}>
                    <span style={{fontSize:13,fontWeight:700,color:'#fbbf24',fontFamily:'"Space Mono",monospace'}}>ðŸ”§ Developer Logs ({devLogs.length})</span>
                    <div style={{display:'flex',gap:10,alignItems:'center'}}>
                      {devLogs.length > 0 && (
                        <span onClick={e=>{e.stopPropagation();setDevLogs([])}} style={{fontSize:11,color:'#6b7280',cursor:'pointer',padding:'2px 8px',borderRadius:4,background:'#12121f'}}>Clear</span>
                      )}
                      <span style={{color:'#6b7280',fontSize:12}}>{showLogs ? 'â–¼' : 'â–¶'}</span>
                    </div>
                  </div>
                  {showLogs && (
                    <div style={{maxHeight:300,overflow:'auto',padding:12,background:'#0d0d18',fontFamily:'"Space Mono",monospace',fontSize:11}}>
                      {devLogs.length === 0 ? (
                        <div style={{color:'#4b5563',fontStyle:'italic'}}>No logs yet. Click "Generate with AI" to see request/response logs.</div>
                      ) : devLogs.map((log, i) => {
                        const colors = { info:'#60a5fa', request:'#a78bfa', response:'#34d399', success:'#22d3ee', error:'#f87171', warning:'#fbbf24' };
                        return (
                          <div key={i} style={{marginBottom:6,lineHeight:1.4}}>
                            <span style={{color:'#4b5563'}}>[{log.time}]</span>{' '}
                            <span style={{color:colors[log.type]||'#9ca3af',fontWeight:700}}>{log.type.toUpperCase()}</span>{' '}
                            <span style={{color:'#d1d5db'}}>{log.message}</span>
                            {log.data && (
                              <div style={{color:'#6b7280',marginLeft:16,marginTop:2,wordBreak:'break-all',whiteSpace:'pre-wrap',maxHeight:80,overflow:'auto',background:'#12121f',padding:4,borderRadius:4,border:'1px solid #1e1e35',fontSize:10}}>
                                {log.data}
                              </div>
                            )}
                          </div>
                        );
                      })}
                      <div ref={logsEndRef} />
                    </div>
                  )}
                </div>
              )}
            </div>
          )}

          {/* ===== STAFF TAB ===== */}
          {activeTab === 'staff' && (
            <div>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:24}}>
                <h2 style={{fontSize:26,fontWeight:700,margin:0}}>Staff Members</h2>
                <Btn onClick={()=>{setEditingStaff(null);setStaffForm({name:'',role:'',color:defaultColors[staff.length%defaultColors.length]});setShowStaffModal(true)}}>+ Add Staff</Btn>
              </div>
              <div style={{display:'flex',flexDirection:'column',gap:14}}>
                {staff.map(s=>{
                  const sr=rules.filter(r=>r.staffId===s.id);
                  const sv=vacations.filter(v=>v.staffId===s.id);
                  const isExpanded = expandedStaffMember === s.id;
                  return(
                    <div key={s.id} style={{background:'#1a1a2e',border:'1px solid #2a2a4a',borderRadius:14,borderTop:`3px solid ${s.color}`,overflow:'hidden'}}>
                      <div style={{padding:'18px 24px',cursor:'pointer',display:'flex',justifyContent:'space-between',alignItems:'center'}}
                        onClick={()=>setExpandedStaffMember(isExpanded?null:s.id)}>
                        <div style={{display:'flex',alignItems:'center',gap:16}}>
                          <div>
                            <div style={{fontSize:17,fontWeight:700}}>{s.name}</div>
                            <div style={{fontSize:12,color:'#6b7280',marginTop:2}}>{s.role||'â€”'}</div>
                          </div>
                          <div style={{display:'flex',gap:8}}>
                            <Chip color={s.color}>{sr.length} rule{sr.length!==1?'s':''}</Chip>
                            <Chip color="#f59e0b">{sv.length} vacation{sv.length!==1?'s':''}</Chip>
                          </div>
                        </div>
                        <div style={{display:'flex',alignItems:'center',gap:10}}>
                          <span onClick={e=>{e.stopPropagation();setEditingStaff(s);setStaffForm({name:s.name,role:s.role,color:s.color});setShowStaffModal(true)}} style={{cursor:'pointer',fontSize:14}}>âœï¸</span>
                          <span onClick={e=>{e.stopPropagation();removeStaff(s.id)}} style={{cursor:'pointer',fontSize:14}}>ðŸ—‘ï¸</span>
                          <span style={{color:'#6b7280',fontSize:14,transition:'transform 0.2s',transform:isExpanded?'rotate(180deg)':'rotate(0deg)'}}>â–¼</span>
                        </div>
                      </div>

                      {isExpanded && (
                        <div style={{borderTop:'1px solid #2a2a4a'}}>
                          {/* Generic month rules calendar */}
                          <div style={{padding:'16px 24px'}}>
                            <span style={{fontSize:13,fontWeight:700,color:'#9ca3af',textTransform:'uppercase',letterSpacing:'0.05em',display:'block',marginBottom:10}}>Weekly Pattern Overview</span>
                            <div style={{borderRadius:10,overflow:'hidden',border:'1px solid #2a2a4a',background:'#12121f'}}>
                              {/* Header row */}
                              <div style={{display:'grid',gridTemplateColumns:'60px repeat(5,1fr)'}}>
                                <div style={{padding:'8px 6px',fontSize:10,fontWeight:700,color:'#4b5563',background:'#0d0d18',borderBottom:'1px solid #2a2a4a',borderRight:'1px solid #2a2a4a'}} />
                                {WEEKDAYS_ONLY.map(d=>(
                                  <div key={d} style={{padding:'8px 4px',textAlign:'center',fontSize:11,fontWeight:700,color:'#9ca3af',background:'#0d0d18',borderBottom:'1px solid #2a2a4a',borderRight:'1px solid #1e1e35',letterSpacing:'0.05em'}}>{d}</div>
                                ))}
                              </div>
                              {/* Week rows */}
                              {[1,2,3,4].map(week => (
                                <div key={week} style={{display:'grid',gridTemplateColumns:'60px repeat(5,1fr)'}}>
                                  <div style={{padding:'6px 8px',fontSize:10,fontWeight:700,color:'#4b5563',background:'#0d0d18',borderRight:'1px solid #2a2a4a',borderBottom:week<4?'1px solid #1e1e35':'none',display:'flex',alignItems:'center'}}>
                                    Wk {week}
                                  </div>
                                  {WEEKDAYS_ONLY.map(day => {
                                    // Find rules matching this day + week
                                    const dayRules = sr.filter(r => {
                                      if (r.dayOfWeek !== day) return false;
                                      const weeks = r.weekOfMonth === 'all' ? [1,2,3,4] : r.weekOfMonth.split(',').map(Number);
                                      return weeks.includes(week);
                                    });

                                    if (dayRules.length === 0) {
                                      return (
                                        <div key={day} style={{padding:4,borderRight:'1px solid #1e1e35',borderBottom:week<4?'1px solid #1e1e35':'none',minHeight:40,display:'flex',alignItems:'center',justifyContent:'center'}}>
                                          <span style={{fontSize:10,color:'#2a2a3a',fontStyle:'italic'}}>â€”</span>
                                        </div>
                                      );
                                    }

                                    return (
                                      <div key={day} style={{padding:3,borderRight:'1px solid #1e1e35',borderBottom:week<4?'1px solid #1e1e35':'none',minHeight:40}}>
                                        {dayRules.map((r,ri) => {
                                          const isOff = r.locationId === 'OFF';
                                          const loc = isOff ? null : locations.find(x=>x.id===r.locationId);
                                          const lc = LOCATION_COLORS[r.locationId] || LOCATION_COLORS.OFF;
                                          const periodLabel = r.period === 'am' ? 'AM' : r.period === 'pm' ? 'PM' : '';
                                          return (
                                            <div key={ri} style={{background:isOff?'#15151f':lc.bg,borderLeft:`2px solid ${isOff?'#333':lc.border}`,borderRadius:3,padding:'3px 5px',marginBottom:ri<dayRules.length-1?2:0}}>
                                              <div style={{fontSize:10,fontWeight:700,color:isOff?'#555':lc.text,lineHeight:1.3,display:'flex',alignItems:'center',gap:3}}>
                                                {periodLabel && <span style={{fontSize:8,color:'#6b7280',fontWeight:800}}>{periodLabel}</span>}
                                                {isOff ? 'OFF' : (loc?.name || '?')}
                                              </div>
                                              {r.priority==='required' && <div style={{width:4,height:4,borderRadius:'50%',background:'#ef4444',display:'inline-block',marginTop:1}} title="Required" />}
                                            </div>
                                          );
                                        })}
                                      </div>
                                    );
                                  })}
                                </div>
                              ))}
                            </div>
                            <div style={{display:'flex',gap:12,marginTop:8,fontSize:10,color:'#4b5563'}}>
                              <span style={{display:'flex',alignItems:'center',gap:4}}><div style={{width:6,height:6,borderRadius:'50%',background:'#ef4444'}} /> Required</span>
                              <span>Color = Location</span>
                              <span>AM/PM shown when split-day</span>
                            </div>
                          </div>

                          {/* Rules section */}
                          <div style={{padding:'16px 24px'}}>
                            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:12}}>
                              <span style={{fontSize:13,fontWeight:700,color:'#9ca3af',textTransform:'uppercase',letterSpacing:'0.05em'}}>Scheduling Rules ({sr.length})</span>
                              <Btn variant="ghost" onClick={()=>{setEditingRule(null);resetRuleForm({staffId:s.id});setShowRuleModal(true)}} style={{fontSize:11,padding:'4px 12px'}}>+ Add Rule</Btn>
                            </div>
                            {sr.length===0 ? (
                              <div style={{fontSize:12,color:'#4b5563',fontStyle:'italic',padding:'8px 0'}}>No rules defined.</div>
                            ) : (
                              <div style={{display:'flex',flexDirection:'column',gap:8}}>
                                {sr.map(r => {
                                  const l = r.locationId==='OFF'?{name:'OFF'}:locations.find(x=>x.id===r.locationId);
                                  return (
                                    <div key={r.id} style={{background:'#12121f',borderRadius:8,padding:'10px 14px',borderLeft:`3px solid ${s.color}`,display:'flex',justifyContent:'space-between',alignItems:'center',gap:10}}>
                                      <div style={{flex:1,fontSize:13}}>
                                        <span style={{color:'#9ca3af',fontWeight:600}}>{r.dayOfWeek}</span>
                                        <span style={{color:'#4b5563'}}> [{formatWeekOfMonth(r.weekOfMonth)}]</span>
                                        {r.period!=='both'&&<span style={{color:'#6b7280'}}> ({r.period.toUpperCase()})</span>}
                                        <span style={{color:'#e8e8f0'}}> â†’ {l?.name||'?'}</span>
                                        <span style={{marginLeft:8}}><Chip color={r.priority==='required'?'#ef4444':r.priority==='preferred'?'#f59e0b':'#6b7280'}>{r.priority}</Chip>{ruleTypeBadge(r)}</span>
                                        {r.description&&<div style={{fontSize:11,color:'#6b7280',marginTop:3}}>{r.description}</div>}
                                      </div>
                                      <div style={{display:'flex',gap:6,flexShrink:0}}>
                                        <span onClick={()=>{setEditingRule(r);setRuleForm({...r,weekOfMonth:r.weekOfMonth||'all',ruleType:r.ruleType||'standard',conditionText:r.conditionText||'',exceptionText:r.exceptionText||'',negativeText:r.negativeText||'',rotateWithStaffId:r.rotateWithStaffId||'',rotateAtLocationId:r.rotateAtLocationId||''});setShowRuleModal(true)}} style={{cursor:'pointer',fontSize:13}}>âœï¸</span>
                                        <span onClick={()=>removeRule(r.id)} style={{cursor:'pointer',fontSize:13}}>ðŸ—‘ï¸</span>
                                      </div>
                                    </div>
                                  );
                                })}
                              </div>
                            )}
                          </div>

                          {/* Vacations section */}
                          <div style={{padding:'16px 24px',borderTop:'1px solid #2a2a4a'}}>
                            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:12}}>
                              <span style={{fontSize:13,fontWeight:700,color:'#9ca3af',textTransform:'uppercase',letterSpacing:'0.05em'}}>Vacation ({sv.length})</span>
                              <Btn variant="ghost" onClick={()=>{setVacationForm({staffId:s.id,startDate:'',endDate:'',reason:''});setShowVacationModal(true)}} style={{fontSize:11,padding:'4px 12px'}}>+ Add Vacation</Btn>
                            </div>
                            {sv.length===0 ? (
                              <div style={{fontSize:12,color:'#4b5563',fontStyle:'italic',padding:'8px 0'}}>No vacations scheduled.</div>
                            ) : (
                              <div style={{display:'flex',flexDirection:'column',gap:8}}>
                                {sv.map(v => (
                                  <div key={v.id} style={{background:'#12121f',borderRadius:8,padding:'10px 14px',borderLeft:'3px solid #f59e0b',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                    <div>
                                      <div style={{fontSize:13,color:'#9ca3af',fontFamily:'"Space Mono",monospace'}}>{v.startDate} â†’ {v.endDate}</div>
                                      {v.reason&&<div style={{fontSize:11,color:'#6b7280',marginTop:2}}>{v.reason}</div>}
                                    </div>
                                    <span onClick={()=>removeVacation(v.id)} style={{cursor:'pointer',fontSize:13}}>ðŸ—‘ï¸</span>
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          {/* ===== LOCATIONS TAB ===== */}
          {activeTab === 'locations' && (
            <div>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:24}}>
                <h2 style={{fontSize:26,fontWeight:700,margin:0}}>Office Locations</h2>
                <Btn onClick={()=>{setEditingLocation(null);setLocationForm({name:'',address:''});setShowLocationModal(true)}}>+ Add Location</Btn>
              </div>
              <div style={{display:'flex',flexDirection:'column',gap:12}}>
                {locations.map(l=>{
                  const lr = rules.filter(r=>r.locationId===l.id);
                  const lc = LOCATION_COLORS[l.id] || LOCATION_COLORS.OFF;
                  const isExpanded = expandedLocation === l.id;
                  return(
                    <div key={l.id} style={{background:'#1a1a2e',border:'1px solid #2a2a4a',borderRadius:12,borderLeft:`3px solid ${lc.border}`,overflow:'hidden'}}>
                      <div style={{padding:'16px 20px',cursor:'pointer',display:'flex',justifyContent:'space-between',alignItems:'center'}}
                        onClick={()=>setExpandedLocation(isExpanded?null:l.id)}>
                        <div style={{display:'flex',alignItems:'center',gap:14}}>
                          <div>
                            <div style={{fontSize:16,fontWeight:700,color:lc.text}}>ðŸ¢ {l.name}</div>
                            {l.address&&<div style={{fontSize:11,color:'#6b7280',marginTop:2}}>{l.address}</div>}
                          </div>
                          <Chip color={lc.text}>{lr.length} rule{lr.length!==1?'s':''}</Chip>
                        </div>
                        <div style={{display:'flex',alignItems:'center',gap:10}}>
                          <span onClick={e=>{e.stopPropagation();setEditingLocation(l);setLocationForm({name:l.name,address:l.address});setShowLocationModal(true)}} style={{cursor:'pointer',fontSize:13}}>âœï¸</span>
                          <span onClick={e=>{e.stopPropagation();removeLocation(l.id)}} style={{cursor:'pointer',fontSize:13}}>ðŸ—‘ï¸</span>
                          <span style={{color:'#6b7280',fontSize:14,transition:'transform 0.2s',transform:isExpanded?'rotate(180deg)':'rotate(0deg)'}}>â–¼</span>
                        </div>
                      </div>

                      {isExpanded && (
                        <div style={{borderTop:'1px solid #2a2a4a',padding:'16px 20px'}}>
                          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:12}}>
                            <span style={{fontSize:13,fontWeight:700,color:'#9ca3af',textTransform:'uppercase',letterSpacing:'0.05em'}}>Rules at {l.name}</span>
                            <Btn variant="ghost" onClick={()=>{setEditingRule(null);resetRuleForm({locationId:l.id});setShowRuleModal(true)}} style={{fontSize:11,padding:'4px 12px'}}>+ Add Rule Here</Btn>
                          </div>
                          {lr.length===0 ? (
                            <div style={{fontSize:12,color:'#4b5563',fontStyle:'italic',padding:'8px 0'}}>No rules assigned to this location.</div>
                          ) : (
                            <div style={{display:'flex',flexDirection:'column',gap:8}}>
                              {lr.map(r => {
                                const s = staff.find(x=>x.id===r.staffId);
                                return (
                                  <div key={r.id} style={{background:'#12121f',borderRadius:8,padding:'10px 14px',borderLeft:`3px solid ${s?.color||'#666'}`,display:'flex',justifyContent:'space-between',alignItems:'center',gap:10}}>
                                    <div style={{flex:1,fontSize:13}}>
                                      <span style={{color:s?.color||'#fff',fontWeight:700}}>{s?.name||'?'}</span>
                                      <span style={{color:'#9ca3af',fontWeight:600,marginLeft:8}}>{r.dayOfWeek}</span>
                                      <span style={{color:'#4b5563'}}> [{formatWeekOfMonth(r.weekOfMonth)}]</span>
                                      {r.period!=='both'&&<span style={{color:'#6b7280'}}> ({r.period.toUpperCase()})</span>}
                                      <span style={{marginLeft:8}}><Chip color={r.priority==='required'?'#ef4444':r.priority==='preferred'?'#f59e0b':'#6b7280'}>{r.priority}</Chip>{ruleTypeBadge(r)}</span>
                                      {r.description&&<div style={{fontSize:11,color:'#6b7280',marginTop:3}}>{r.description}</div>}
                                    </div>
                                    <div style={{display:'flex',gap:6,flexShrink:0}}>
                                      <span onClick={()=>{setEditingRule(r);setRuleForm({...r,weekOfMonth:r.weekOfMonth||'all',ruleType:r.ruleType||'standard',conditionText:r.conditionText||'',exceptionText:r.exceptionText||'',negativeText:r.negativeText||'',rotateWithStaffId:r.rotateWithStaffId||'',rotateAtLocationId:r.rotateAtLocationId||''});setShowRuleModal(true)}} style={{cursor:'pointer',fontSize:13}}>âœï¸</span>
                                      <span onClick={()=>removeRule(r.id)} style={{cursor:'pointer',fontSize:13}}>ðŸ—‘ï¸</span>
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          {/* ===== RULES TAB ===== */}
          {activeTab === 'rules' && (
            <div>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16,flexWrap:'wrap',gap:12}}>
                <h2 style={{fontSize:26,fontWeight:700,margin:0}}>Scheduling Rules</h2>
                <Btn onClick={()=>{setEditingRule(null);resetRuleForm();setShowRuleModal(true)}}
                  disabled={staff.length===0||locations.length===0}>+ Add Rule</Btn>
              </div>

              {/* Filter by provider */}
              <div style={{display:'flex',gap:8,flexWrap:'wrap',marginBottom:20}}>
                <div onClick={()=>setRulesFilter('all')}
                  style={{padding:'6px 14px',borderRadius:20,cursor:'pointer',fontSize:12,fontWeight:600,
                    background:rulesFilter==='all'?'#6366f122':'#12121f',color:rulesFilter==='all'?'#818cf8':'#6b7280',border:`1px solid ${rulesFilter==='all'?'#6366f1':'#2a2a4a'}`}}>
                  All ({rules.length})
                </div>
                {staff.map(s=>{
                  const count=rules.filter(r=>r.staffId===s.id).length;
                  if(count===0) return null;
                  return(
                    <div key={s.id} onClick={()=>setRulesFilter(s.id)}
                      style={{padding:'6px 14px',borderRadius:20,cursor:'pointer',fontSize:12,fontWeight:600,
                        background:rulesFilter===s.id?s.color+'22':'#12121f',color:rulesFilter===s.id?s.color:'#6b7280',border:`1px solid ${rulesFilter===s.id?s.color:'#2a2a4a'}`}}>
                      {getLastName(s.name)} ({count})
                    </div>
                  );
                })}
              </div>

              <div style={{display:'flex',flexDirection:'column',gap:10}}>
                {filteredRules.map(r=>{
                  const s=staff.find(x=>x.id===r.staffId);
                  const l=r.locationId==='OFF'?{name:'OFF'}:locations.find(x=>x.id===r.locationId);
                  return(
                    <div key={r.id} style={{background:'#1a1a2e',border:'1px solid #2a2a4a',borderRadius:12,padding:16,borderLeft:`3px solid ${s?.color||'#666'}`}}>
                      <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',gap:12}}>
                        <div style={{flex:1}}>
                          <div style={{fontSize:14,fontWeight:600,marginBottom:4}}>
                            <span style={{color:s?.color||'#fff'}}>{s?.name||'?'}</span>
                            <span style={{color:'#6b7280'}}> â€” {r.dayOfWeek}</span>
                            <span style={{color:'#4b5563'}}> [{formatWeekOfMonth(r.weekOfMonth)}]</span>
                            <span style={{color:'#9ca3af'}}> {r.period!=='both'?`(${r.period.toUpperCase()})`:''}</span>
                            <span style={{color:'#e8e8f0'}}> â†’ {l?.name||'?'}</span>
                          </div>
                          <div style={{display:'flex',gap:8,alignItems:'center',flexWrap:'wrap'}}>
                            <Chip color={r.priority==='required'?'#ef4444':r.priority==='preferred'?'#f59e0b':'#6b7280'}>{r.priority}</Chip>{ruleTypeBadge(r)}
                            {r.description && <span style={{fontSize:12,color:'#6b7280',lineHeight:1.4}}>{r.description}</span>}
                          </div>
                        </div>
                        <div style={{display:'flex',gap:6,flexShrink:0}}>
                          <span onClick={()=>{setEditingRule(r);setRuleForm({...r,weekOfMonth:r.weekOfMonth||'all',ruleType:r.ruleType||'standard',conditionText:r.conditionText||'',exceptionText:r.exceptionText||'',negativeText:r.negativeText||'',rotateWithStaffId:r.rotateWithStaffId||'',rotateAtLocationId:r.rotateAtLocationId||''});setShowRuleModal(true)}} style={{cursor:'pointer'}}>âœï¸</span>
                          <span onClick={()=>removeRule(r.id)} style={{cursor:'pointer'}}>ðŸ—‘ï¸</span>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          {/* ===== VACATIONS TAB ===== */}
          {activeTab === 'vacations' && (
            <div>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:24}}>
                <h2 style={{fontSize:26,fontWeight:700,margin:0}}>Vacation</h2>
                <Btn onClick={()=>{setVacationForm({staffId:staff[0]?.id||'',startDate:'',endDate:'',reason:''});setShowVacationModal(true)}} disabled={staff.length===0}>+ Add Vacation</Btn>
              </div>
              {vacations.length===0?(
                <div style={{textAlign:'center',padding:60,color:'#4b5563'}}><div style={{fontSize:48,marginBottom:16}}>ðŸ–ï¸</div><p>No vacations scheduled.</p></div>
              ):(
                <div style={{display:'flex',flexDirection:'column',gap:12}}>
                  {vacations.map(v=>{
                    const s=staff.find(x=>x.id===v.staffId);
                    return(
                      <div key={v.id} style={{background:'#1a1a2e',border:'1px solid #2a2a4a',borderRadius:12,padding:18,display:'flex',justifyContent:'space-between',alignItems:'center',borderLeft:`3px solid ${s?.color||'#666'}`}}>
                        <div>
                          <div style={{fontSize:14,fontWeight:600,color:s?.color||'#fff'}}>{s?.name||'?'}</div>
                          <div style={{fontSize:13,color:'#9ca3af',marginTop:4,fontFamily:'"Space Mono",monospace'}}>{v.startDate} â†’ {v.endDate}</div>
                          {v.reason&&<div style={{fontSize:12,color:'#6b7280',marginTop:4}}>{v.reason}</div>}
                        </div>
                        <span onClick={()=>removeVacation(v.id)} style={{cursor:'pointer'}}>ðŸ—‘ï¸</span>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          )}

          {/* ===== HOLIDAYS TAB ===== */}
          {activeTab === 'holidays' && (
            <div>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:24}}>
                <div>
                  <h2 style={{fontSize:26,fontWeight:700,margin:0}}>Company Holidays</h2>
                  <p style={{color:'#6b7280',fontSize:13,marginTop:4}}>Office-wide closures that apply to all locations and staff</p>
                </div>
                <Btn onClick={()=>{setEditingHoliday(null);setHolidayForm({name:'',month:0,day:1,note:''});setShowHolidayModal(true)}}>+ Add Holiday</Btn>
              </div>
              {holidays.length===0?(
                <div style={{textAlign:'center',padding:60,color:'#4b5563'}}><div style={{fontSize:48,marginBottom:16}}>ðŸ“†</div><p>No holidays defined.</p></div>
              ):(
                <div style={{display:'flex',flexDirection:'column',gap:12}}>
                  {holidays.map(h=>{
                    const dateThisYear = getHolidayDate(h, currentYear);
                    const dateStr = dateThisYear ? dateThisYear.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }) : 'Date varies';
                    const isFloating = h.type !== 'fixed';
                    const isHalfDay = h.halfDay === 'am';
                    return(
                      <div key={h.id} style={{background:'#1a1a2e',border:'1px solid #2a2a4a',borderRadius:12,padding:18,display:'flex',justifyContent:'space-between',alignItems:'center',borderLeft:`3px solid ${isHalfDay?'#f59e0b':'#ef4444'}`}}>
                        <div style={{flex:1}}>
                          <div style={{display:'flex',alignItems:'center',gap:8,flexWrap:'wrap'}}>
                            <span style={{fontSize:16,fontWeight:700,color:'#e8e8f0'}}>{h.name}</span>
                            {isHalfDay && <span style={{fontSize:9,padding:'2px 8px',borderRadius:10,background:'#78350f33',color:'#f59e0b',border:'1px solid #f59e0b44',fontWeight:700}}>AM Only</span>}
                            {!isHalfDay && <span style={{fontSize:9,padding:'2px 8px',borderRadius:10,background:'#7f1d1d33',color:'#ef4444',border:'1px solid #ef444444',fontWeight:700}}>Closed</span>}
                            {isFloating && <span style={{fontSize:9,padding:'2px 8px',borderRadius:10,background:'#6366f122',color:'#818cf8',border:'1px solid #6366f144',fontWeight:600}}>Floating</span>}
                          </div>
                          <div style={{fontSize:13,color:'#9ca3af',marginTop:4,fontFamily:'"Space Mono",monospace'}}>
                            {currentYear}: {dateStr}
                          </div>
                          {h.note&&<div style={{fontSize:12,color:'#6b7280',marginTop:4}}>{h.note}</div>}
                        </div>
                        <div style={{display:'flex',gap:8,flexShrink:0}}>
                          <span onClick={()=>{
                            setEditingHoliday(h);
                            setHolidayForm({name:h.name, month:h.month, day:h.day||1, halfDay:h.halfDay||'closed', note:h.note||''});
                            setShowHolidayModal(true);
                          }} style={{cursor:'pointer',fontSize:14}}>âœï¸</span>
                          <span onClick={()=>removeHoliday(h.id)} style={{cursor:'pointer',fontSize:14}}>ðŸ—‘ï¸</span>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}

              {/* Year preview */}
              <div style={{marginTop:24,padding:'16px 20px',background:'#1a1a2e',borderRadius:12,border:'1px solid #2a2a4a'}}>
                <h3 style={{fontSize:16,fontWeight:700,marginBottom:12}}>ðŸ“… {currentYear} Holiday Calendar</h3>
                <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(220,1fr))',gap:10}}>
                  {holidays.map(h => {
                    const dt = getHolidayDate(h, currentYear);
                    if (!dt) return null;
                    return (
                      <div key={h.id} style={{background:'#12121f',borderRadius:8,padding:'10px 14px',borderLeft:'3px solid #ef4444',display:'flex',alignItems:'center',gap:10}}>
                        <div style={{fontSize:24,fontWeight:800,color:'#ef4444',fontFamily:'"Space Mono",monospace',width:32,textAlign:'center'}}>{dt.getDate()}</div>
                        <div>
                          <div style={{fontSize:12,fontWeight:600,color:'#e8e8f0'}}>{h.name}</div>
                          <div style={{fontSize:10,color:'#6b7280'}}>{MONTHS[dt.getMonth()]} {dt.getDate()}, {currentYear}</div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          )}
        </div>
      </div>

      {/* ====== MODALS ====== */}

      <Modal open={showStaffModal} onClose={()=>{setShowStaffModal(false);setEditingStaff(null)}} title={editingStaff?'Edit Staff':'Add Staff Member'}>
        <Input label="Full Name" value={staffForm.name} onChange={v=>setStaffForm(p=>({...p,name:v}))} placeholder="e.g., Jane Smith MD" />
        <Input label="Role / Title" value={staffForm.role} onChange={v=>setStaffForm(p=>({...p,role:v}))} placeholder="e.g., Ophthalmologist" />
        <div style={{marginBottom:16}}>
          <label style={{display:'block',fontSize:12,color:'#9ca3af',marginBottom:8,textTransform:'uppercase',letterSpacing:'0.05em'}}>Color</label>
          <div style={{display:'flex',gap:8,flexWrap:'wrap'}}>
            {defaultColors.map(c=>(<div key={c} onClick={()=>setStaffForm(p=>({...p,color:c}))} style={{width:28,height:28,borderRadius:'50%',background:c,cursor:'pointer',border:staffForm.color===c?'3px solid #fff':'3px solid transparent',transition:'all 0.15s'}} />))}
          </div>
        </div>
        <div style={{display:'flex',gap:10,justifyContent:'flex-end',marginTop:24}}>
          <Btn variant="ghost" onClick={()=>{setShowStaffModal(false);setEditingStaff(null)}}>Cancel</Btn>
          <Btn onClick={addStaff}>{editingStaff?'Save':'Add Staff'}</Btn>
        </div>
      </Modal>

      <Modal open={showLocationModal} onClose={()=>{setShowLocationModal(false);setEditingLocation(null)}} title={editingLocation?'Edit Location':'Add Location'}>
        <Input label="Location Name" value={locationForm.name} onChange={v=>setLocationForm(p=>({...p,name:v}))} placeholder="e.g., Main Office" />
        <Input label="Description (optional)" value={locationForm.address} onChange={v=>setLocationForm(p=>({...p,address:v}))} placeholder="e.g., Surgery Center" />
        <div style={{display:'flex',gap:10,justifyContent:'flex-end',marginTop:24}}>
          <Btn variant="ghost" onClick={()=>{setShowLocationModal(false);setEditingLocation(null)}}>Cancel</Btn>
          <Btn onClick={addLocation}>{editingLocation?'Save':'Add Location'}</Btn>
        </div>
      </Modal>

      <Modal open={showRuleModal} onClose={()=>{setShowRuleModal(false);setEditingRule(null)}} title={editingRule?'Edit Rule':'Add Scheduling Rule'} wide>
        {/* Rule Type Selector */}
        <div style={{marginBottom:16}}>
          <div style={{fontSize:11,fontWeight:700,color:'#9ca3af',textTransform:'uppercase',marginBottom:6}}>Rule Type</div>
          <div style={{display:'flex',flexWrap:'wrap',gap:6}}>
            {[{v:'standard',l:'ðŸ“‹ Standard',c:'#6366f1'},{v:'conditional',l:'ðŸ”€ Conditional (IF/THEN)',c:'#f59e0b'},{v:'exception',l:'âš ï¸ Exception',c:'#ef4444'},{v:'negative',l:'ðŸš« Negative Constraint',c:'#ec4899'},{v:'rotation',l:'ðŸ”„ Rotation/Shared',c:'#10b981'},{v:'complex',l:'ðŸ“ Complex (Free Text)',c:'#8b5cf6'}].map(t=>(
              <div key={t.v} onClick={()=>setRuleForm(p=>({...p,ruleType:t.v}))}
                style={{padding:'6px 14px',borderRadius:8,cursor:'pointer',fontSize:12,fontWeight:600,
                  background:ruleForm.ruleType===t.v?t.c+'22':'#12121f',color:ruleForm.ruleType===t.v?t.c:'#6b7280',
                  border:'1px solid '+(ruleForm.ruleType===t.v?t.c:'#2a2a4a'),transition:'all 0.15s'}}>{t.l}</div>
            ))}
          </div>
        </div>

        {/* Common: Staff selector (all types) */}
        <Select label="Staff Member" value={ruleForm.staffId} onChange={v=>setRuleForm(p=>({...p,staffId:v}))}
          options={staff.map(s=>({value:s.id,label:s.name}))} />

        {/* Standard, Conditional, Exception: Day/Week/Period/Location */}
        {(ruleForm.ruleType === 'standard' || ruleForm.ruleType === 'conditional' || ruleForm.ruleType === 'exception' || ruleForm.ruleType === 'rotation') && (
          <div>
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16,marginTop:12}}>
              <Select label="Day of Week" value={ruleForm.dayOfWeek} onChange={v=>setRuleForm(p=>({...p,dayOfWeek:v}))}
                options={WEEKDAYS_ONLY.map(d=>({value:d,label:d}))} />
              <Select label="Time Period" value={ruleForm.period} onChange={v=>setRuleForm(p=>({...p,period:v}))}
                options={[{value:'both',label:'Full Day'},{value:'am',label:'AM Only'},{value:'pm',label:'PM Only'}]} />
            </div>
            <WeekOfMonthPicker value={ruleForm.weekOfMonth} onChange={v=>setRuleForm(p=>({...p,weekOfMonth:v}))} />
            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16}}>
              <Select label="Assign to Location" value={ruleForm.locationId} onChange={v=>setRuleForm(p=>({...p,locationId:v}))}
                options={[...locations.map(l=>({value:l.id,label:l.name})),{value:'OFF',label:'OFF (Day Off)'}]} />
              <Select label="Priority" value={ruleForm.priority} onChange={v=>setRuleForm(p=>({...p,priority:v}))}
                options={[{value:'required',label:'ðŸ”´ Required'},{value:'preferred',label:'ðŸŸ¡ Preferred'},{value:'optional',label:'âšª Optional'}]} />
            </div>
          </div>
        )}

        {/* Conditional: IF condition */}
        {ruleForm.ruleType === 'conditional' && (
          <Textarea label="IF Condition (when should this rule apply?)" value={ruleForm.conditionText} onChange={v=>setRuleForm(p=>({...p,conditionText:v}))}
            placeholder="e.g., IF Dr. Choi was at DHM last month, THEN assign Dr. Yang to DHM this month" rows={3} />
        )}

        {/* Exception: base rule + exception condition */}
        {ruleForm.ruleType === 'exception' && (
          <Textarea label="EXCEPTION condition (when should this rule NOT apply?)" value={ruleForm.exceptionText} onChange={v=>setRuleForm(p=>({...p,exceptionText:v}))}
            placeholder="e.g., EXCEPTION: If 1st Friday falls on 1st of month AND Dr. Tittler was NOT in surgery the day before â†’ move to 2nd Friday" rows={3} />
        )}

        {/* Negative constraint */}
        {ruleForm.ruleType === 'negative' && (
          <Textarea label="Negative Constraint (what should NOT happen?)" value={ruleForm.negativeText} onChange={v=>setRuleForm(p=>({...p,negativeText:v}))}
            placeholder="e.g., Does NOT want 3 Stockton Thursdays in a month. Maximum 2." rows={3} />
        )}

        {/* Rotation: who to rotate with and where */}
        {ruleForm.ruleType === 'rotation' && (
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16,marginTop:8}}>
            <Select label="Rotates With" value={ruleForm.rotateWithStaffId} onChange={v=>setRuleForm(p=>({...p,rotateWithStaffId:v}))}
              options={staff.filter(s=>s.id!==ruleForm.staffId).map(s=>({value:s.id,label:s.name}))} />
            <Select label="Rotation Location" value={ruleForm.rotateAtLocationId} onChange={v=>setRuleForm(p=>({...p,rotateAtLocationId:v}))}
              options={locations.map(l=>({value:l.id,label:l.name}))} />
          </div>
        )}

        {/* Complex: free text */}
        {ruleForm.ruleType === 'complex' && (
          <Textarea label="Describe the rule in plain English" value={ruleForm.description} onChange={v=>setRuleForm(p=>({...p,description:v}))}
            placeholder="e.g., If Kim is at Turlock on 1st Friday AND Tittler was NOT in surgery Thursday, move Kim to 2nd Friday and notify Turlock Eye Care. Otherwise keep 1st Friday." rows={4} />
        )}

        {/* Notes (for all types except complex which uses description field) */}
        {ruleForm.ruleType !== 'complex' && ruleForm.ruleType !== 'negative' && (
          <Textarea label="Notes (optional)" value={ruleForm.description} onChange={v=>setRuleForm(p=>({...p,description:v}))} placeholder="Additional context..." rows={2} />
        )}

        <div style={{display:'flex',gap:10,justifyContent:'flex-end',marginTop:24}}>
          <Btn variant="ghost" onClick={()=>{setShowRuleModal(false);setEditingRule(null)}}>Cancel</Btn>
          <Btn onClick={addRule}>{editingRule?'Save':'Add Rule'}</Btn>
        </div>
      </Modal>

      {/* Ambiguity Resolution Modal */}
      <Modal open={!!genAmbiguities && genAmbiguities.length > 0} onClose={()=>{setGenAmbiguities(null);setGenPendingContext(null)}} title="âš ï¸ Critical Scheduling Decisions Needed" wide>
        <div style={{fontSize:13,color:'#9ca3af',marginBottom:16}}>The AI encountered situations it couldn't resolve automatically. Please make a decision for each:</div>
        {genAmbiguities && genAmbiguities.map((amb, ai) => (
          <div key={amb.id || ai} style={{background:'#1a1520',border:'1px solid #92400e',borderRadius:8,padding:'14px 16px',marginBottom:12}}>
            <div style={{fontSize:13,fontWeight:600,color:'#fbbf24',marginBottom:6}}>{amb.question}</div>
            <div style={{fontSize:12,color:'#9ca3af',marginBottom:8}}>AI chose: {amb.chose}</div>
            <div style={{display:'flex',flexWrap:'wrap',gap:6}}>
              {(amb.alternatives || []).map((alt, oi) => (
                <div key={oi} onClick={()=>setGenAmbiguityAnswers(prev=>({...prev,[amb.id||ai]:alt}))}
                  style={{padding:'6px 14px',borderRadius:6,cursor:'pointer',fontSize:12,fontWeight:600,
                    background:genAmbiguityAnswers[amb.id||ai]===alt?'#6366f133':'#12121f',
                    color:genAmbiguityAnswers[amb.id||ai]===alt?'#818cf8':'#6b7280',
                    border:'1px solid '+(genAmbiguityAnswers[amb.id||ai]===alt?'#6366f1':'#2a2a4a')}}>{alt}</div>
              ))}
              <div onClick={()=>setGenAmbiguityAnswers(prev=>({...prev,[amb.id||ai]:amb.chose}))}
                style={{padding:'6px 14px',borderRadius:6,cursor:'pointer',fontSize:12,fontWeight:600,
                  background:genAmbiguityAnswers[amb.id||ai]===amb.chose?'#10b98133':'#12121f',
                  color:genAmbiguityAnswers[amb.id||ai]===amb.chose?'#10b981':'#6b7280',
                  border:'1px solid '+(genAmbiguityAnswers[amb.id||ai]===amb.chose?'#10b981':'#2a2a4a')}}>Keep AI's choice</div>
            </div>
          </div>
        ))}
        <div style={{display:'flex',gap:10,justifyContent:'flex-end',marginTop:20}}>
          <Btn variant="ghost" onClick={()=>{setGenAmbiguities(null);setGenPendingContext(null);setGenAmbiguityAnswers({})}}>Cancel (keep current schedule)</Btn>
          <Btn variant="success" onClick={()=>{
            const decisions = {};
            if (genAmbiguities) genAmbiguities.forEach((amb, ai) => {
              const key = amb.id || 'ambiguity_' + ai;
              decisions[amb.question] = genAmbiguityAnswers[key] || amb.chose;
            });
            setGenAmbiguities(null);
            setGenPendingContext(null);
            setGenAmbiguityAnswers({});
            generateWithAI(decisions);
          }}>Re-generate with My Decisions</Btn>
        </div>
      </Modal>

      <Modal open={showVacationModal} onClose={()=>setShowVacationModal(false)} title="Add Vacation">
        <Select label="Staff Member" value={vacationForm.staffId} onChange={v=>setVacationForm(p=>({...p,staffId:v}))}
          options={staff.map(s=>({value:s.id,label:s.name}))} />
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16}}>
          <Input label="Start Date" value={vacationForm.startDate} onChange={v=>setVacationForm(p=>({...p,startDate:v}))} type="date" />
          <Input label="End Date" value={vacationForm.endDate} onChange={v=>setVacationForm(p=>({...p,endDate:v}))} type="date" />
        </div>
        <Input label="Reason (optional)" value={vacationForm.reason} onChange={v=>setVacationForm(p=>({...p,reason:v}))} placeholder="e.g., Conference, family vacation" />
        <div style={{display:'flex',gap:10,justifyContent:'flex-end',marginTop:24}}>
          <Btn variant="ghost" onClick={()=>setShowVacationModal(false)}>Cancel</Btn>
          <Btn onClick={addVacation}>Add Vacation</Btn>
        </div>
      </Modal>

      <Modal open={showHolidayModal} onClose={()=>{setShowHolidayModal(false);setEditingHoliday(null)}} title={editingHoliday?'Edit Holiday':'Add Holiday'}>
        <Input label="Holiday Name" value={holidayForm.name} onChange={v=>setHolidayForm(p=>({...p,name:v}))} placeholder="e.g., Veterans Day" />
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:16}}>
          <Select label="Month" value={holidayForm.month} onChange={v=>setHolidayForm(p=>({...p,month:parseInt(v)}))}
            options={MONTHS.map((m,i)=>({value:i,label:m}))} />
          <Select label="Day" value={holidayForm.day} onChange={v=>setHolidayForm(p=>({...p,day:parseInt(v)}))}
            options={Array.from({length:31},(_,i)=>({value:i+1,label:String(i+1)}))} />
          <Select label="Closure Type" value={holidayForm.halfDay||'closed'} onChange={v=>setHolidayForm(p=>({...p,halfDay:v}))}
            options={[{value:'closed',label:'Full Day Closed'},{value:'am',label:'AM Only (close at noon)'}]} />
        </div>
        <Input label="Note (optional)" value={holidayForm.note} onChange={v=>setHolidayForm(p=>({...p,note:v}))} placeholder="e.g., Office open AM only" />
        <p style={{fontSize:11,color:'#4b5563',marginTop:4}}>Note: For floating holidays (e.g., 3rd Monday), edit the saved holiday definition directly.</p>
        <div style={{display:'flex',gap:10,justifyContent:'flex-end',marginTop:24}}>
          <Btn variant="ghost" onClick={()=>{setShowHolidayModal(false);setEditingHoliday(null)}}>Cancel</Btn>
          <Btn onClick={addHoliday}>{editingHoliday?'Save':'Add Holiday'}</Btn>
        </div>
      </Modal>

      <Modal open={!!editCell} onClose={()=>setEditCell(null)} title={editCell?`${MONTHS[currentMonth]} ${editCell.day}, ${currentYear} â€” Week ${getWeekOfMonth(editCell.day)}`:''} wide>
        {editCell&&(
          <div>
            <p style={{fontSize:13,color:'#6b7280',marginBottom:16}}>Assign each provider to a location for AM and PM.</p>
            <div style={{maxHeight:'60vh',overflow:'auto'}}>
              {staff.map(s=>{
                const onVac=isOnVacation(s.id,editCell.dk);
                return(
                  <div key={s.id} style={{padding:12,background:'#12121f',borderRadius:10,marginBottom:8,borderLeft:`3px solid ${s.color}`}}>
                    <div style={{fontSize:14,fontWeight:600,color:s.color,marginBottom:8}}>
                      {s.name}<span style={{fontSize:11,color:'#6b7280',fontWeight:400,marginLeft:8}}>{s.role}</span>
                      {onVac&&<span style={{fontSize:11,color:'#f59e0b',marginLeft:8}}>âš ï¸ Vacation</span>}
                    </div>
                    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10}}>
                      {['am','pm'].map(period=>(
                        <div key={period}>
                          <label style={{display:'block',fontSize:10,color:'#6b7280',marginBottom:3,textTransform:'uppercase',fontWeight:700}}>{period}</label>
                          <select value={schedule[editCell.dk]?.[s.id]?.[period]||''} onChange={e=>setDayAssignment(editCell.day,s.id,period,e.target.value)}
                            style={{width:'100%',padding:'7px 10px',background:'#1a1a2e',border:'1px solid #2a2a4a',borderRadius:8,color:'#e8e8f0',fontSize:13,fontFamily:'"DM Sans",sans-serif'}}>
                            <option value="">â€” Unassigned â€”</option>
                            {locations.map(l=><option key={l.id} value={l.id}>{l.name}{l.address?` (${l.address})`:''}</option>)}
                            <option value="OFF">OFF</option>
                          </select>
                        </div>
                      ))}
                    </div>
                  </div>
                );
              })}
            </div>
            <div style={{display:'flex',justifyContent:'flex-end',marginTop:16}}><Btn onClick={()=>setEditCell(null)}>Done</Btn></div>
          </div>
        )}
      </Modal>

      <style>{`
        @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
        ::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:#0d0d1a}::-webkit-scrollbar-thumb{background:#2a2a4a;border-radius:4px}
        select option{background:#1a1a2e;color:#e8e8f0}
        input[type="date"]::-webkit-calendar-picker-indicator{filter:invert(0.7)}
      `}</style>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(window.ScheduleHelper));
</script></body></html>
